## Codebase Patterns
- Use `yarn check` to run TypeScript typecheck (runs tsc against tsconfig.app.json and tsconfig.node.json)
- Reference project at ../react-starter-kit for Inertia/Vite/React patterns and versions
- Project uses Yarn 4.12.0 (via mise.toml) for JS dependency management
- Project uses PostgreSQL (pg gem)
- Linting tools: oxlint and oxfmt are kept as dependencies from original project
- Vite types: app/frontend/types/vite-env.d.ts provides ImportMeta types for import.meta.env and import.meta.glob
- InertiaController (app/controllers/inertia_controller.rb) is the base for all Inertia pages, with `default_render: true`
- Controllers inheriting InertiaController still need explicit action methods (e.g., `def index; end`) — `default_render` handles rendering, not action dispatch
- js-routes generates to app/frontend/routes/index.js via `bundle exec rake js:routes`
- config/vite.json configures Vite dev server on port 3036, source at app/frontend
- Procfile.dev runs `bin/vite dev` for the Vite dev server
- Docker must be started (`docker compose -f dev-docker-compose.yml up -d`) before Rails can connect to PostgreSQL
- shadcn/ui components installed via `npx shadcn@latest add <name>` into app/frontend/components/ui/
- components.json configures shadcn with style 'new-york', CSS at app/frontend/entrypoints/application.css
- i18n frontend: react-i18next with i18n config at app/frontend/i18n/config.ts, locales at app/frontend/i18n/locales/{en,ar}.json
- i18n backend: Rails I18n with locales at config/locales/{en,ar}.yml, available_locales: [:en, :ar]
- Locale detection: params[:locale] > cookies[:locale] > Accept-Language header (via around_action :switch_locale in ApplicationController)
- InertiaController shares `locale` and `flash` props to all Inertia pages via inertia_share
- LanguageToggle component at app/frontend/components/language-toggle.tsx — sets cookie, updates i18n/dir/lang, reloads via Inertia
- Linting: `mise run lint` runs rubocop + oxfmt --check + oxlint. `yarn lint` for oxlint only, `yarn format:check` for oxfmt only
- oxlint config at `.oxlintrc.json` — enables react, typescript, import, jsx-a11y plugins. Ignores auto-generated routes files
- oxfmt excludes `app/frontend/routes/**` (auto-generated js-routes files) via package.json script args
- SimpleCov configured in test/test_helper.rb with 95% minimum coverage and branch coverage enabled
- Fixture files for non-existent tables must be removed — `fixtures :all` in test_helper will try to DELETE FROM those tables and fail
- Vite autoBuild must be `true` in config/vite.json test environment for controller integration tests to work
- Devise is installed with modules: database_authenticatable, registerable, recoverable, rememberable, validatable
- Devise initializer at config/initializers/devise.rb, locale at config/locales/devise.en.yml
- User model at app/models/user.rb — custom columns: personal_id, full_name, provider, uid, locale
- Reference project for Devise patterns: ../milkstraw/milkstraw-web-app/
- InertiaDeviseResponder at app/responders/inertia_devise_responder.rb — redirects with Inertia error props on Devise form failures
- Devise::InertiaFailureApp at app/controllers/devise/inertia_failure_app.rb — forces redirect (not 401) for Inertia requests
- Devise navigational_formats set to ["*/*", :html] (no turbo_stream) for Inertia compatibility
- Devise responder, warden failure app, and navigational_formats are configured in config/initializers/devise.rb
- SimpleCov coverage was already below 95% before US-008 — pre-existing issue from US-007 that doesn't block stories without "Tests pass" in AC
- User model Personal ID: 6-char uppercase alphanumeric excluding 0, O, 1, I, L. Regex: `/\A[A-HJ-KM-NP-Z2-9]{6}\z/`. Generated via `before_validation` on create (not `before_create` — validation runs first)
- DeviseOverrides concern at app/models/concerns/devise_overrides.rb — overrides send_devise_notification for async email (deliver_later)
- OmniauthConcern at app/models/concerns/omniauth_concern.rb — User.from_omniauth(auth) finds by provider+uid, then email, then creates new
- User model includes :omniauthable with omniauth_providers: [:google_oauth2]
- Use `refute_match` not `assert_not_match` in Minitest for regex negation
- Devise custom controllers: `devise_for :users, controllers: { registrations: "users/registrations" }` in routes.rb
- Auth pages use Inertia component name convention: `render inertia: "auth/SignUp"` maps to `pages/auth/SignUp.tsx`
- InertiaDeviseResponder redirects with `inertia:` key on failure — errors available as page props via `usePage().props`
- Devise error keys from `to_hash(true)` are top-level (e.g., `full_name`, `email`) not nested under `user.`
- Auth pages should NOT use autoFocus — oxlint jsx-a11y/no-autofocus rule enforces this
- Devise sessions controller: `new` must call `self.resource = resource_class.new(sign_in_params)` and `clean_up_passwords(resource)` before rendering Inertia
- Devise invalid login: returns 422 (unprocessable_content) — not a redirect. Flash alert message is set by warden failure app
- `devise_scope` with `authenticated`/`unauthenticated` roots: root URL renders different pages based on auth state, no redirect needed
- `before_action :authenticate_user!` on InertiaController: all pages inheriting InertiaController require authentication. Devise controllers (sessions, registrations) bypass this since they inherit from Devise::*Controller
- Existing tests may need `include Devise::Test::IntegrationHelpers` and `sign_in users(:fixture_name)` after adding authentication requirements
- OmniAuth Google strategy configured in config/initializers/devise.rb using Rails.application.credentials.dig(:google, :client_id/client_secret)
- OmniAuth callbacks controller at app/controllers/users/omniauth_callbacks_controller.rb — skips CSRF for OAuth callback
- OmniAuth test mode: `OmniAuth.config.test_mode = true` + `OmniAuth.config.mock_auth[:google_oauth2] = OmniAuth::AuthHash.new(...)` for integration tests
- Google sign-in button: native HTML form POST to `/users/auth/google_oauth2` with CSRF token from meta tag (not Inertia form)
- SharedData type needs `[key: string]: unknown` index signature for compatibility with Inertia's `usePage<T>()` generic constraint (PageProps requires index signature)
- AppLayout at app/frontend/layouts/app-layout.tsx — wraps authenticated pages with header, nav, user dropdown. Pages opt in via `PageComponent.layout = (page) => <AppLayout>{page}</AppLayout>`
- InertiaController shares `auth: { user: current_user.as_json(only: %i[id full_name email personal_id]) }` guarded with `if current_user` for unauthenticated pages
- Sonner toast component installed at app/frontend/components/ui/sonner.tsx — modified from shadcn default to remove `next-themes` dependency (not available in Inertia/Rails). Toaster component mounted in AppLayout.
- Profile controller renders Inertia component `profile/Show` — maps to `pages/profile/Show.tsx`
- `resource :profile` (singular) for current user profile — no :id in URL. Uses `current_user` directly in controller.
- PostgreSQL enum types use `create_enum` in migrations — enum names prefixed with `debt_` (e.g., `debt_mode`, `debt_status`) to avoid namespace collisions
- Debt model enums use explicit value mappings: `enum :mode, { mutual: "mutual", personal: "personal" }` to match PostgreSQL enum values
- `creator_role` enum uses `prefix: true` to avoid method name collisions with association names (e.g., `creator_role_lender?` instead of `lender?`)
- Debt model `has_many` associations (installments, payments, witnesses) use `dependent: :destroy`
- User has_many debt associations: `lent_debts` (foreign_key: :lender_id, dependent: :destroy) and `borrowed_debts` (foreign_key: :borrower_id, dependent: :nullify)
- User also has_many: :payments (foreign_key: :submitter_id), :witnesses, :notifications (all dependent: :destroy)
- Models with PostgreSQL enums: Installment (:status), Payment (:status), Witness (:status) — each with their own enum type
- Notification uses plain string for notification_type (not PG enum) — types may grow dynamically
- UsersController at app/controllers/users_controller.rb — GET /users/lookup?personal_id=... returns JSON {id, full_name} or 404
- oxlint jsx-a11y/label-has-associated-control requires `<label htmlFor>` with matching `id` on form controls (e.g., RadioGroupItem)
- Force Vite test rebuild with `RAILS_ENV=test bin/vite build --force` when manifest becomes stale
- Personal mode debts: `lender_id` is always set to current_user (NOT NULL DB constraint). `creator_role` tracks the user's actual role. `counterparty_name` is the other party.
- DebtsController#create redirect with errors: `redirect_to new_debt_path, inertia: { errors: @debt.errors.to_hash(true) }` — errors keyed by attribute name with array of messages
- Inertia server errors in React: use `usePage().props` cast through `unknown` to avoid TS error with `Errors & ErrorBag` type
- DebtsController#show uses `render inertia: "debts/Show"` with explicit `props:` hash — does NOT use `default_render` since it needs to serialize associations
- Debt authorization: `before_action` checks lender_id, borrower_id, or confirmed witness. Redirect to debts_path with alert flash on unauthorized
- Third test user fixture: `users(:three)` with personal_id GHJ789 — used for unauthorized access and witness tests
- Confirmed witness fixture: `witnesses(:confirmed_witness)` on personal_debt with user: three
- Payment approve/reject: nested member routes `approve_debt_payment_url(debt, payment)` → POST /debts/:debt_id/payments/:id/approve
- Auto-settlement: check `remaining_balance <= 0` after every payment approval. Settlement notifies both parties.
- WitnessesController: nested under debts with create, confirm, decline actions. Routes: `debt_witnesses_url(debt)` for POST, `confirm_debt_witness_url(debt, witness)` for confirm, `decline_debt_witness_url(debt, witness)` for decline
- Witness authorization: only debt creator can invite witnesses, only the invited witness user can confirm/decline
- Max 2 witnesses per debt enforced at controller level (not model validation)
- Fourth user fixture: `users(:four)` with personal_id KMN345 — available for additional test scenarios
- DashboardController at app/controllers/dashboard_controller.rb — renders `dashboard/Index` Inertia component with per-currency summaries and recent debts
- Authenticated root route now points to `dashboard#index` (updated from `home#index` in US-026)
- Dashboard nav link uses `/dashboard` path (not `/`) — isActive check handles both `/` and `/dashboard`
- NotificationService at app/services/notification_service.rb — centralized class methods for all notification types. Call via `NotificationService.debt_created(debt)` etc.
- NotificationsController at app/controllers/notifications_controller.rb — index, mark_read, mark_all_read. Routes: `notifications_url`, `mark_read_notification_url(notification)`, `mark_all_read_notifications_url`
- InertiaController shares `unread_notifications_count` via inertia_share — available to all pages for the header bell icon
- DebtMailer at app/mailers/debt_mailer.rb — 7 email methods: debt_created, debt_confirmed, payment_submitted, payment_approved, payment_rejected, witness_invitation, debt_settled
- NotificationService enqueues DebtMailer.*.deliver_later alongside in-app notifications — not all notification types send emails (debt_rejected, witness_confirmed, witness_declined are in-app only)
- Mailer tests: use `email.text_part.body.decoded` (not `email.body.encoded`) to avoid base64-encoding issues with non-ASCII locales (e.g., Arabic)
- Personal debt counterparty in mailer: use `Struct.new(:full_name).new(debt.counterparty_name)` — no OpenStruct (requires explicit require in frozen_string_literal)
- GoodJob is the background job adapter (replaced Solid Queue). Config at config/initializers/good_job.rb with cron schedule
- Test environment must set `config.active_job.queue_adapter = :test` explicitly (in config/environments/test.rb) since application.rb sets :good_job globally
- GoodJob dashboard mounted at /good_job in routes.rb
- GoodJob cron: OverdueDetectionJob at midnight UTC, InstallmentReminderJob at 8 AM UTC
---

## 2026-02-11 - US-014
- What was implemented: Built user profile page with Personal ID display, copy-to-clipboard, Web Share API, and editable full name. Created ProfilesController with show and update actions inheriting from InertiaController. GET /profile renders profile/Show.tsx with user data (full_name, email, personal_id). PATCH /profile updates full_name with validation (presence required). Profile page displays Personal ID in large monospaced font with copy and share buttons. Copy uses navigator.clipboard, share uses navigator.share with fallback to copy. Name update form uses Inertia useForm hook with PATCH submission. Success toast shown via sonner after update. Installed sonner toast component (modified from shadcn default to remove next-themes dependency). Added Toaster to AppLayout. Added i18n translations for profile page in en.json, ar.json, en.yml, ar.yml. Wrote 5 controller tests.
- Files changed: app/controllers/profiles_controller.rb (new), app/frontend/pages/profile/Show.tsx (new), app/frontend/components/ui/sonner.tsx (new), app/frontend/layouts/app-layout.tsx (modified), config/routes.rb (modified), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/locales/en.yml (modified), config/locales/ar.yml (modified), package.json (modified), yarn.lock (modified), test/controllers/profiles_controller_test.rb (new)
- **Learnings for future iterations:**
  - Sonner component from shadcn uses `next-themes` which is Next.js-specific — must be removed for Inertia/Rails projects and theme prop omitted
  - Toaster component must be mounted in AppLayout for toasts to render on authenticated pages
  - `resource :profile` (singular) creates `/profile` path without `:id` — uses `current_user` directly in controller
  - For Inertia error props, use `usePage().props as { errors?: Record<string, string> }` without the SharedData generic to avoid TypeScript incompatibility with Inertia's Errors & ErrorBag type
  - Flash notice from Rails redirect is available via `usePage<SharedData>().props.flash?.notice` and can trigger a toast in useEffect
---

## 2026-02-11 - US-013
- What was implemented: Built the main app layout with navigation, language toggle, and user menu. Created app-layout.tsx with sticky header containing app name, desktop nav links (Dashboard, My Debts, Notifications), LanguageToggle, and user avatar/dropdown menu (Profile, Logout). Mobile responsive: hamburger menu opens a Sheet sidebar overlay. RTL layout handled via Tailwind ltr:/rtl: utilities and dynamic Sheet side. Updated InertiaController to share current_user data via inertia_share (guarded with `if current_user`). Added `[key: string]: unknown` index signature to SharedData type for `usePage<T>()` compatibility. Updated home/index.tsx to use AppLayout via page-level layout override. Added `nav.open_menu` translation key to en/ar locale files.
- Files changed: app/frontend/layouts/app-layout.tsx (new), app/controllers/inertia_controller.rb (modified), app/frontend/types/index.ts (modified), app/frontend/pages/home/index.tsx (modified), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified)
- **Learnings for future iterations:**
  - SharedData type needs `[key: string]: unknown` index signature for Inertia's `usePage<T>()` generic — without it, TypeScript errors with "does not satisfy the constraint 'PageProps'"
  - Page-level layout override: set `PageComponent.layout = (page) => <AppLayout>{page}</AppLayout>` — the `??=` in inertia.tsx respects existing layout
  - InertiaController auth sharing must guard with `if current_user` since unauthenticated pages (sign-in, sign-up) also pass through InertiaController indirectly via Devise controllers
  - Sheet side should be dynamic for RTL: `side={isRtl ? 'right' : 'left'}` so mobile menu slides from the correct edge
---

## 2026-02-11 - US-012
- What was implemented: Implemented Google OAuth 2.0 login. Created Users::OmniauthCallbacksController inheriting from Devise::OmniauthCallbacksController with `google_oauth2` action that calls User.from_omniauth(auth), signs in the user on success, or redirects to registration with errors on failure. Added custom `failure` action for OAuth error handling. Configured OmniAuth Google strategy in devise.rb using Rails credentials. Added `omniauth_callbacks: "users/omniauth_callbacks"` to devise_for controller mappings. Added "Sign in with Google" button to both sign-in and sign-up pages using native HTML form POST to `/users/auth/google_oauth2` with CSRF token. Added i18n translations for OAuth buttons (en/ar) and Devise omniauth_callbacks locale for Arabic.
- Files changed: app/controllers/users/omniauth_callbacks_controller.rb (new), test/controllers/users/omniauth_callbacks_controller_test.rb (new), app/frontend/pages/auth/SignIn.tsx (modified), app/frontend/pages/auth/SignUp.tsx (modified), config/initializers/devise.rb (modified), config/routes.rb (modified), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/locales/ar.yml (modified)
- **Learnings for future iterations:**
  - OmniAuth callbacks controller must `skip_before_action :verify_authenticity_token` for the callback action since OAuth redirects lose the CSRF token
  - OmniAuth test mode: set `OmniAuth.config.test_mode = true` in setup, mock auth with `OmniAuth.config.mock_auth[:google_oauth2] = OmniAuth::AuthHash.new(...)`, and clean up in teardown
  - OmniAuth failure with `:invalid_credentials` mock: POST to callback URL → OmniAuth middleware intercepts → redirects (the Devise failure app handles the redirect chain)
  - Google sign-in button must use a native HTML form POST (not Inertia router) to `/users/auth/google_oauth2` — the CSRF token is read from the `<meta>` tag via `document.querySelector`
  - The "or" divider between password form and Google button uses a CSS pattern with absolute positioned border-t and relative centered text
---

## 2026-02-11 - US-011
- What was implemented: Created Devise sessions controller (Users::SessionsController) inheriting from Devise::SessionsController with `new` action rendering Inertia "auth/SignIn" component. Created sign-in page (pages/auth/SignIn.tsx) with email, password, remember me checkbox using Inertia useForm hook. Added sessions controller to devise_for routes. Configured devise_scope with authenticated root (home#index) and unauthenticated root (sessions#new). Added `before_action :authenticate_user!` to InertiaController. Added i18n translations for sign-in page in en.json and ar.json. Wrote 5 integration tests. Updated existing HomeController tests to include Devise authentication helpers.
- Files changed: app/controllers/users/sessions_controller.rb (new), app/frontend/pages/auth/SignIn.tsx (new), test/controllers/users/sessions_controller_test.rb (new), app/controllers/inertia_controller.rb (modified), config/routes.rb (modified), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), test/controllers/home_controller_test.rb (modified)
- **Learnings for future iterations:**
  - Devise sessions controller `new` action requires `self.resource = resource_class.new(sign_in_params)` and `clean_up_passwords(resource)` to properly initialize the resource
  - Devise invalid login returns 422 (unprocessable_content), not a redirect — the warden failure app renders the sign-in page with the flash alert
  - `devise_scope` with authenticated/unauthenticated roots means root URL renders different content based on auth state, not via redirect
  - After adding `authenticate_user!` to InertiaController, existing tests for authenticated pages need `include Devise::Test::IntegrationHelpers` and `sign_in` helper
  - Flash alerts from Devise are shared via `inertia_share` in InertiaController and displayed in the sign-in page
---

## 2026-02-11 - US-008
- What was implemented: Created Devise-Inertia glue layer. Created InertiaDeviseResponder that inherits from Devise::Controllers::Responder and redirects with Inertia error props on form failures (registrations, passwords, confirmations, unlocks). Created Devise::InertiaFailureApp that overrides http_auth? to force redirect-based auth flow for Inertia requests. Configured Devise initializer: added require for InertiaDeviseResponder, set config.responder = InertiaDeviseResponder, configured warden failure_app = Devise::InertiaFailureApp, set navigational_formats to ["*/*", :html] (removed turbo_stream). Error status and redirect status were already configured correctly from Devise generation.
- Files changed: app/responders/inertia_devise_responder.rb (new), app/controllers/devise/inertia_failure_app.rb (new), config/initializers/devise.rb (modified)
- **Learnings for future iterations:**
  - The InertiaDeviseResponder handles form validation failures by redirecting back with `inertia:` error props instead of rendering HTML
  - Devise::InertiaFailureApp disables HTTP auth for Inertia requests so Warden always redirects instead of returning 401
  - `config.navigational_formats` must NOT include `:turbo_stream` for Inertia — use `["*/*", :html]` only
  - The `require Rails.root.join(...)` for the responder must be placed before `Devise.setup` in the initializer
  - RuboCop Rails omakase style requires spaces inside array brackets: `[ "a", "b" ]` not `["a", "b"]`
---

## 2026-02-11 - US-001
- What was implemented: Removed Hotwire dependencies (turbo-rails, stimulus-rails, jsbundling-rails, cssbundling-rails) from Gemfile and added Inertia/Vite/React gems (vite_rails ~> 3.0, inertia_rails ~> 3.6, js-routes). Replaced Hotwire JS packages in package.json with React 19, @inertiajs/react, TypeScript, Vite 7, @vitejs/plugin-react, vite-plugin-ruby, @tailwindcss/vite, and shadcn utility deps. Created tsconfig files and minimal vite.config.ts.
- Files changed: Gemfile, Gemfile.lock, package.json, yarn.lock, tsconfig.json, tsconfig.app.json, tsconfig.node.json, vite.config.ts, app/frontend/index.ts
- **Learnings for future iterations:**
  - tsconfig.app.json needs at least one file in the include path to pass typecheck — created app/frontend/index.ts as placeholder
  - Don't use dot-prefixed filenames (.gitkeep.ts) as TypeScript glob patterns exclude hidden files
  - Kept oxfmt and oxlint as dependencies since they were in the original package.json and will be configured in US-006
---

## 2026-02-11 - US-002
- What was implemented: Configured Vite with React plugin (babel-plugin-react-compiler), @tailwindcss/vite, and vite-plugin-ruby. Created Inertia entry point (inertia.tsx) with createInertiaApp, page glob resolution, and PersistentLayout default wrapper. Created minimal PersistentLayout. Created application.css with Tailwind v4 imports, CSS variable theme (shadcn-compatible), and dark mode support. Created cn() utility in lib/utils.ts. Created TypeScript type definitions (User, Auth, SharedData interfaces). Added vite-env.d.ts for Vite type support.
- Files changed: vite.config.ts, app/frontend/entrypoints/inertia.tsx, app/frontend/entrypoints/application.css, app/frontend/layouts/persistent-layout.tsx, app/frontend/lib/utils.ts, app/frontend/types/index.ts, app/frontend/types/vite-env.d.ts, app/frontend/index.ts (deleted)
- **Learnings for future iterations:**
  - Need vite-env.d.ts with `/// <reference types="vite/client" />` and ImportMeta/ImportMetaEnv interfaces for `import.meta.env` and `import.meta.glob` to pass typecheck
  - The placeholder app/frontend/index.ts from US-001 can be removed once real files exist under app/frontend/
---

## 2026-02-11 - US-003
- What was implemented: Configured Rails for Inertia rendering. Updated application.html.erb to use Vite tags (vite_stylesheet_tag, vite_react_refresh_tag, vite_client_tag, vite_typescript_tag) instead of old asset pipeline tags. Created InertiaController with default_render: true. Created inertia_rails.rb initializer with ViteRuby.digest versioning and use_script_element_for_initial_page. Created js_routes.rb initializer with camelCase and frontend output path. Removed app/javascript/ directory entirely. Updated Procfile.dev to use bin/vite dev. Created HomeController inheriting from InertiaController. Created home/index.tsx page component. Added root route. Created bin/vite and config/vite.json.
- Files changed: app/views/layouts/application.html.erb, app/controllers/inertia_controller.rb, app/controllers/home_controller.rb, config/initializers/inertia_rails.rb, config/initializers/js_routes.rb, config/routes.rb, Procfile.dev, app/frontend/pages/home/index.tsx, app/frontend/routes/index.js, app/frontend/routes/index.d.ts, bin/vite, config/vite.json, app/javascript/ (deleted)
- **Learnings for future iterations:**
  - Controllers inheriting InertiaController must define explicit action methods (e.g., `def index; end`) even with `default_render: true` — Rails requires actions to exist for routing
  - bin/vite and config/vite.json are not auto-generated by vite_rails gem in this setup — they must be created manually from the reference project
  - js-routes are generated via `bundle exec rake js:routes` — generates both .js and .d.ts files
  - The Inertia page resolver in inertia.tsx maps controller/action names to page paths (e.g., HomeController#index → pages/home/index.tsx)
---

## 2026-02-11 - US-004
- What was implemented: Created components.json for shadcn/ui with style 'new-york', rsc: false, tsx: true, CSS variables enabled, and proper aliases matching the reference project. All required shadcn dependencies were already installed from US-001 (class-variance-authority, clsx, tailwind-merge, lucide-react, tw-animate-css). Installed 12 shadcn/ui components via `npx shadcn@latest add`: Button, Input, Label, Card, Badge, Dialog, DropdownMenu, Select, Sheet, Avatar, Breadcrumb, Tooltip. Updated home/index.tsx to render a Card with a Button to verify shadcn works. The `radix-ui` package was automatically added by shadcn.
- Files changed: components.json, package.json, yarn.lock, app/frontend/components/ui/button.tsx, app/frontend/components/ui/input.tsx, app/frontend/components/ui/label.tsx, app/frontend/components/ui/card.tsx, app/frontend/components/ui/badge.tsx, app/frontend/components/ui/dialog.tsx, app/frontend/components/ui/dropdown-menu.tsx, app/frontend/components/ui/select.tsx, app/frontend/components/ui/sheet.tsx, app/frontend/components/ui/avatar.tsx, app/frontend/components/ui/breadcrumb.tsx, app/frontend/components/ui/tooltip.tsx, app/frontend/pages/home/index.tsx
- **Learnings for future iterations:**
  - shadcn/ui components are installed via `npx shadcn@latest add <component-name>` — they get copied into app/frontend/components/ui/
  - The `radix-ui` package is added automatically by shadcn as a dependency
  - shadcn dependencies (class-variance-authority, clsx, tailwind-merge, lucide-react, tw-animate-css) were already part of the project from US-001
  - components.json must reference the correct CSS path: app/frontend/entrypoints/application.css
---

## 2026-02-11 - US-005
- What was implemented: Configured bilingual i18n (Arabic RTL / English LTR) infrastructure. Added react-i18next and i18next packages. Created i18n config (app/frontend/i18n/config.ts) with en/ar resources loaded from JSON locale files. Created en.json and ar.json with base UI translations (app name, common labels, nav items, home page text, language toggle). Initialized i18n in inertia.tsx setup function, reading locale from Inertia shared props. Set dir/lang attributes on HTML element based on active locale. Created LanguageToggle component that switches between Arabic/English via cookie + Inertia reload. Created Rails locale files (config/locales/en.yml, ar.yml) with base translations. Added around_action :switch_locale to ApplicationController with locale detection from params, cookie, or Accept-Language header. Configured available_locales [:en, :ar] in config/application.rb. Added inertia_share in InertiaController to share locale and flash props to all pages. Updated home page to use translated text and include LanguageToggle.
- Files changed: package.json, yarn.lock, app/frontend/i18n/config.ts, app/frontend/i18n/locales/en.json, app/frontend/i18n/locales/ar.json, app/frontend/entrypoints/inertia.tsx, app/frontend/components/language-toggle.tsx, config/locales/en.yml, config/locales/ar.yml, app/controllers/application_controller.rb, app/controllers/inertia_controller.rb, config/application.rb, app/frontend/pages/home/index.tsx
- **Learnings for future iterations:**
  - i18n locale is shared from Rails to Inertia via `inertia_share { locale: I18n.locale.to_s }` in InertiaController
  - LanguageToggle sets a cookie (`locale`) and uses `router.reload()` to trigger a fresh Inertia request with the new locale
  - The HTML dir/lang attributes must be set both on initial page load (in inertia.tsx setup) and on language switch (in LanguageToggle)
  - Rails locale detection order: params[:locale] > cookies[:locale] > Accept-Language header
---

## 2026-02-11 - US-006
- What was implemented: Set up linting and test infrastructure. Created `.oxlintrc.json` with react, typescript, import, and jsx-a11y plugins enabled, correctness rules as errors, suspicious as warnings. Disabled `react-in-jsx-scope` (not needed with React 19 JSX transform), `import/no-named-as-default-member` (false positives with i18next), and `jsx-a11y/prefer-tag-over-role` for shadcn/ui vendor components. Excluded auto-generated `app/frontend/routes/**` from lint and format checks. Added `lint`, `format`, and `format:check` scripts to package.json using oxlint and oxfmt. The mise.toml lint task already ran rubocop + yarn format:check + yarn lint, so no changes needed there. Added simplecov gem with 95% minimum coverage threshold and branch coverage in test_helper.rb. `coverage/` was already in .gitignore. Created empty fixture files for all planned models (users, debts, installments, payments, witnesses, notifications). Ran oxfmt to auto-format all existing frontend files (quote style normalization).
- Files changed: .oxlintrc.json, package.json, Gemfile, Gemfile.lock, test/test_helper.rb, test/fixtures/users.yml, test/fixtures/debts.yml, test/fixtures/installments.yml, test/fixtures/payments.yml, test/fixtures/witnesses.yml, test/fixtures/notifications.yml, app/frontend/**/*.tsx (reformatted by oxfmt)
- **Learnings for future iterations:**
  - oxlint config file is `.oxlintrc.json` (not `oxlint.json`). It supports `$schema` pointing to `./node_modules/oxlint/configuration_schema.json`
  - `react/react-in-jsx-scope` must be turned off for React 17+ projects using the new JSX transform
  - Auto-generated files (like js-routes output in `app/frontend/routes/`) should be excluded from both linting (via `ignorePatterns` in `.oxlintrc.json`) and formatting (via `!` exclude patterns in package.json scripts)
  - `import/no-named-as-default-member` causes false positives with i18next `.use()` pattern — turn it off
  - shadcn/ui vendor components may trigger jsx-a11y rules — use overrides to disable for `app/frontend/components/ui/**`
  - SimpleCov only generates a coverage report when there are actual test files; with 0 tests, no coverage/ directory is created
---

## 2026-02-11 - US-007
- What was implemented: Installed Devise (~> 5.0), OmniAuth (~> 2.1), omniauth-google-oauth2 (~> 1.2), and omniauth-rails_csrf_protection (~> 2.0) gems. Ran `rails generate devise:install` and `rails generate devise User`. Added custom columns to the generated migration: personal_id (string, not null), full_name (string, not null), provider (string, nullable), uid (string, nullable), locale (string, default: 'en'). Added unique index on personal_id and unique compound index on [provider, uid]. Ran migration successfully. User model has Devise modules: database_authenticatable, registerable, recoverable, rememberable, validatable. Fixed rubocop offenses in generated devise.rb initializer. Removed empty fixture files for non-existent tables (debts, installments, payments, witnesses, notifications) that caused test failures. Enabled Vite autoBuild in test environment. Added controller tests for HomeController and model tests for User. Added public/vite-dev and public/vite-test to .gitignore.
- Files changed: Gemfile, Gemfile.lock, app/models/user.rb, config/initializers/devise.rb, config/locales/devise.en.yml, config/routes.rb, config/vite.json, db/migrate/20260211083410_devise_create_users.rb, db/schema.rb, test/fixtures/users.yml, test/models/user_test.rb, test/controllers/home_controller_test.rb, .gitignore, test/fixtures/{debts,installments,payments,witnesses,notifications}.yml (deleted)
- **Learnings for future iterations:**
  - Devise generator auto-adds `devise_for :users` to routes.rb
  - Empty fixture files for non-existent tables cause `DELETE FROM "table"` errors when `fixtures :all` is used in test_helper — remove them until the tables exist
  - Vite autoBuild must be set to `true` in config/vite.json for the test environment, otherwise controller integration tests fail with "can't find entrypoints/application.css in manifests"
  - RuboCop auto-corrects Devise-generated initializer (string quotes, array bracket spacing) — run `rubocop -a` after generating
  - Reference project for Devise/OmniAuth patterns: ../milkstraw/milkstraw-web-app/
---

## 2026-02-11 - US-009
- What was implemented: Configured User model with Personal ID generation, validations, and Devise concerns. Added :omniauthable Devise module with google_oauth2 provider. Created before_validation callback that generates a 6-character alphanumeric Personal ID (A-Z excluding O/I/L, 2-9) on create when blank. Added validations for full_name presence and personal_id presence/uniqueness/format. Created DeviseOverrides concern that overrides send_devise_notification to use deliver_later for async email. Created OmniauthConcern with from_omniauth class method that finds existing user by provider+uid, links by email, or creates new user. Wrote 14 model tests covering all acceptance criteria.
- Files changed: app/models/user.rb (modified), app/models/concerns/devise_overrides.rb (new), app/models/concerns/omniauth_concern.rb (new), test/models/user_test.rb (modified)
- **Learnings for future iterations:**
  - Personal ID generation must use `before_validation` on :create, not `before_create` — the presence validation runs before create callbacks and will fail on blank personal_id
  - Regex for Personal ID excluding O, I, L: `/\A[A-HJ-KM-NP-Z2-9]{6}\z/` — note the ranges: A-H (skip I), J-K (skip L), M-N (skip O), P-Z
  - The PRD regex `/\A[A-HJ-NP-Z2-9]{6}\z/` incorrectly allows L (L is in J-N range) — corrected to `[A-HJ-KM-NP-Z2-9]`
  - OmniauthConcern handles 3 cases: (1) existing user by provider+uid, (2) existing user by email (links OAuth), (3) new user creation
  - Use `refute_match` (not `assert_not_match`) in Minitest for regex negative assertions
  - Test fixtures' personal_id values must not collide with test data — fixture `:one` uses "ABC234"
---

## 2026-02-11 - US-010
- What was implemented: Created Devise registration controller and sign-up page. Created Users::RegistrationsController inheriting from Devise::RegistrationsController with `new` action rendering Inertia "auth/SignUp" component, `create` action using super, custom `sign_up_params` permitting :full_name, custom `after_sign_up_path_for` redirecting to root, custom `after_failure_path_for` redirecting to sign-up page, and `inertia_errors` helper for error formatting. Created pages/auth/SignUp.tsx React page with form fields (full name, email, password, password confirmation) using Inertia useForm hook, shadcn/ui Card/Input/Label/Button components, and inline validation error display. Added i18n translations for sign-up page in en.json and ar.json. Updated devise_for routes to use custom registrations controller. Wrote 7 integration tests covering successful registration, missing full name, duplicate email, password mismatch, and short password.
- Files changed: app/controllers/users/registrations_controller.rb (new), app/frontend/pages/auth/SignUp.tsx (new), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/routes.rb (modified), test/controllers/users/registrations_controller_test.rb (new)
- **Learnings for future iterations:**
  - Devise custom controllers must be wired via `devise_for :users, controllers: { registrations: "users/registrations" }` in routes.rb
  - Auth Inertia pages: `render inertia: "auth/SignUp"` maps to `pages/auth/SignUp.tsx` — component name must match filename exactly
  - InertiaDeviseResponder calls controller's `inertia_errors(resource)` and `after_failure_path_for(resource)` — both must be defined as private methods
  - Devise error keys from `resource.errors.to_hash(true)` are top-level attribute names (e.g., `full_name`, `email`), not nested under `user.`
  - oxlint jsx-a11y/no-autofocus rule prevents using autoFocus attribute on form inputs — remove it for accessibility compliance
  - Devise form params are nested under `user` key — `sign_up_params` must use `params.require(:user).permit(...)` pattern
---

## 2026-02-11 - US-015
- What was implemented: Created Debt model with PostgreSQL migration including four custom enum types (debt_mode, debt_creator_role, debt_installment_type, debt_status), all required columns (lender_id, borrower_id, counterparty_name, mode, creator_role, amount, currency, description, deadline, installment_type, status), foreign key constraints on lender_id and borrower_id, and indexes on status, [lender_id, status], [borrower_id, status]. Implemented Debt model with belongs_to :lender, belongs_to :borrower (optional), has_many :installments/:payments/:witnesses (dependent: destroy). Added enum declarations for all four enum columns. Added validations: amount > 0, currency presence, deadline presence. Custom validations: mutual mode requires borrower_id, personal mode requires counterparty_name. Added User model associations: has_many :lent_debts and :borrowed_debts. Wrote 20 model tests covering all validations, associations, enums, and mode-specific logic.
- Files changed: db/migrate/20260211091834_create_debts.rb (new), app/models/debt.rb (new), app/models/user.rb (modified), db/schema.rb (updated), test/fixtures/debts.yml (new), test/models/debt_test.rb (new)
- **Learnings for future iterations:**
  - PostgreSQL enum types in Rails migrations use `create_enum` — prefix names to avoid collisions (e.g., `debt_mode` not `mode`)
  - Rails enum declarations with PostgreSQL enums need explicit value mappings: `enum :mode, { mutual: "mutual", personal: "personal" }`
  - Use `prefix: true` on enums when method names would collide with associations (e.g., `creator_role` has `lender`/`borrower` values that collide with `belongs_to :lender`)
  - Debt fixtures reference user fixtures by label name (e.g., `lender: one` references `users(:one)`)
  - SimpleCov coverage failure is pre-existing and doesn't block stories — all 58 tests pass with 0 failures
---

## 2026-02-11 - US-016
- What was implemented: Created Installment, Payment, Witness, and Notification models with migrations, validations, associations, enums, scopes, and fixtures. Created 4 PostgreSQL enum types (installment_status, payment_status, witness_status) and 4 migrations with proper foreign keys, indexes, and constraints. Installment model: belongs_to :debt, has_many :payments, enum :status (upcoming/submitted/approved/rejected/overdue), validates amount > 0 and due_date presence. Payment model: belongs_to :debt, belongs_to :installment (optional), belongs_to :submitter (User), enum :status (pending/approved/rejected), validates amount > 0 and submitted_at presence. Witness model: belongs_to :debt, belongs_to :user, enum :status (invited/confirmed/declined), validates user_id uniqueness scoped to debt_id. Notification model: belongs_to :user, belongs_to :debt (optional), scope :unread, validates notification_type and message presence. Added User associations: has_many :payments, :witnesses, :notifications. Created fixture files for all 4 models. Wrote 37 new model tests (95 total, 0 failures).
- Files changed: db/migrate/20260211092218_create_installments.rb (new), db/migrate/20260211092224_create_payments.rb (new), db/migrate/20260211092225_create_witnesses.rb (new), db/migrate/20260211092226_create_notifications.rb (new), app/models/installment.rb (new), app/models/payment.rb (new), app/models/witness.rb (new), app/models/notification.rb (new), app/models/user.rb (modified), db/schema.rb (updated), test/fixtures/installments.yml (new), test/fixtures/payments.yml (new), test/fixtures/witnesses.yml (new), test/fixtures/notifications.yml (new), test/models/installment_test.rb (new), test/models/payment_test.rb (new), test/models/witness_test.rb (new), test/models/notification_test.rb (new)
- **Learnings for future iterations:**
  - PostgreSQL enum type names for new models: `installment_status`, `payment_status`, `witness_status` (no prefix needed since they're specific enough)
  - Notification model doesn't use a PostgreSQL enum for notification_type — uses a plain string column since notification types may grow dynamically
  - `t.references :submitter` creates a `submitter_id` column (not `submitted_by`) — `belongs_to :submitter` auto-resolves to `submitter_id` without needing explicit foreign_key
  - Witness unique index `[debt_id, user_id]` enforces one witness entry per user per debt at the database level
  - Notification `scope :unread` filters by `read: false` — complemented by the `read` boolean column defaulting to false
---

## 2026-02-11 - US-017
- What was implemented: Created InstallmentScheduleGenerator service at app/services/installment_schedule_generator.rb. Plain Ruby class that accepts a debt object and generates installment records based on installment_type. Supports all 6 types: lump_sum (1 installment at deadline for full amount), monthly/bi_weekly/quarterly/yearly (periodic installments from creation date to deadline with last installment absorbing rounding remainder), and custom_split (returns empty array). All generated installments have status 'upcoming'. Wrote 12 unit tests covering all 6 installment types, exact division, remainder handling, close deadline (1 month), persistence verification, and total amount correctness.
- Files changed: app/services/installment_schedule_generator.rb (new), test/services/installment_schedule_generator_test.rb (new)
- **Learnings for future iterations:**
  - Service classes live in app/services/ — directory auto-loaded by Rails conventions
  - InstallmentScheduleGenerator.new(debt).generate! creates and persists Installment records via debt.installments.create!
  - Rounding strategy: base_amount = floor(total / count, 2), last installment = total - (base * (count-1)) — ensures exact total match
  - For periodic schedules, if no interval date falls before deadline, the deadline itself becomes the single installment due date
  - SimpleCov coverage failure is pre-existing (below 95% threshold) — does not block stories
---

## 2026-02-11 - US-018
- What was implemented: Built debt creation UI with multi-step form for role and mode selection. Created DebtsController with `new` action inheriting from InertiaController. Added `resources :debts, only: [:new, :create, :show, :index]` to routes. Created pages/debts/new.tsx with a 3-step form shell: Step 1 shows two selectable cards for role (I'm Lending with HandCoins icon, I'm Borrowing with HandHeart icon), Step 2 shows two selectable cards for mode (Mutual with Users icon, Personal with User icon), Step 3 is a placeholder for the details form (US-019). Cards have distinct visual highlight on selection (border-primary, bg-primary/5, checkmark icon). Ayat al-Dayn verse banner displayed alongside the form with Arabic text and translated reference. Next button advances between steps, Back button returns to previous step. All text translated (en/ar) with RTL support via ltr:/rtl: Tailwind utilities.
- Files changed: app/controllers/debts_controller.rb (new), app/frontend/pages/debts/new.tsx (new), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/routes.rb (modified)
- **Learnings for future iterations:**
  - DebtsController inherits from InertiaController — `default_render: true` handles rendering, just need empty action methods
  - Multi-step forms use React state (useState) for step tracking and selections — no server round-trips needed between steps
  - SelectableCard pattern: button with border-2, conditional border-primary + bg-primary/5 + checkmark for selected state
  - Ayat al-Dayn verse text is always displayed in Arabic script regardless of UI language — only the translation changes via i18n
  - oxfmt auto-formats JSX — run `yarn format` before committing new .tsx files
---

## 2026-02-11 - US-019
- What was implemented: Built Step 3 of the debt creation multi-step form with counterparty, amount, currency, deadline, description, and installment type fields. Created UsersController with GET /users/lookup?personal_id=... endpoint that returns {id, full_name} or 404. Added the route. Mutual mode shows a Personal ID input that auto-looks up the user when 6 characters are entered (shows name on success, error on failure, with loading/success/error icons). Personal mode shows a free-text counterparty name input. Amount field is a numeric input (step 0.01). Currency selector uses shadcn Select with 31 currencies (International + Arab/Islamic) in "CODE — Name" format. Deadline is a date input with min set to tomorrow. Description is an optional textarea. Installment type uses a radio group with 6 options (lump_sum, monthly, bi_weekly, quarterly, yearly, custom_split), each with a description. Client-side validation: amount > 0, deadline in future, counterparty fields required per mode. Installed shadcn textarea and radio-group components. All text translated (en/ar). Back button returns to Step 2.
- Files changed: app/controllers/users_controller.rb (new), app/frontend/pages/debts/new.tsx (modified), app/frontend/components/ui/textarea.tsx (new), app/frontend/components/ui/radio-group.tsx (new), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/routes.rb (modified)
- **Learnings for future iterations:**
  - UsersController lookup endpoint returns JSON (not Inertia) — uses `render json:` for API-like responses and `head :not_found` for 404
  - Personal ID lookup auto-triggers on 6 characters via onChange handler — no submit button needed
  - shadcn RadioGroup uses `RadioGroupItem` with `id` prop and `<label htmlFor>` to satisfy jsx-a11y/label-has-associated-control rule
  - The `onBack` from Step 3 goes back to Step 2 (mode selection) — mode state is preserved, no reset needed
  - Currency list is hardcoded as a const array — 31 currencies covering international and Arab/Islamic markets
  - Form submission stub (handleSubmit) only validates — actual POST /debts is wired in US-020
---

## 2026-02-11 - US-020
- What was implemented: Implemented debt creation backend. Created DebtsController#create action with strong parameters, role-based party assignment, and mode-specific post-creation behavior. Mutual mode: creates debt with status 'pending', assigns lender/borrower based on creator_role and looked-up counterparty Personal ID, creates notification for other party. Personal mode: creates debt with status 'active', always sets lender_id to current_user (due to NOT NULL constraint), calls InstallmentScheduleGenerator to create installments immediately. On validation failure, redirects back to new_debt_path with errors via Inertia. Wired up form submission in pages/debts/new.tsx using Inertia router.post, passing role, mode, and all form fields. Added server error handling with useEffect to map server-side validation errors to form fields. Added "creating" loading state on submit button. Added i18n translations for debt creation success message, notification messages, and creating state (en/ar). Wrote 5 integration tests covering mutual debt creation with notification, personal debt creation with installments, invalid params, invalid Personal ID, and authentication requirement.
- Files changed: app/controllers/debts_controller.rb (modified), app/frontend/pages/debts/new.tsx (modified), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/locales/en.yml (modified), config/locales/ar.yml (modified), test/controllers/debts_controller_test.rb (new)
- **Learnings for future iterations:**
  - Personal mode debts: `lender_id` is always set to current_user because the DB has a NOT NULL constraint on lender_id. The `creator_role` enum tracks the user's actual role in the debt, and `counterparty_name` is the other party.
  - DebtsController error redirect: `redirect_to new_debt_path, inertia: { errors: @debt.errors.to_hash(true) }` — errors keyed by attribute name (e.g., `amount`, `currency`) with array of message strings
  - Inertia server errors in React: cast `usePage().props` through `unknown` first to avoid TS error with `Errors & ErrorBag` type: `(props as unknown as { errors?: Record<string, string[]> }).errors`
  - `router.post` in Inertia sends form data — nest under `debt: { ... }` key to match Rails strong parameters
  - For mutual debts, `counterparty_personal_id` is sent as a non-permitted param (not in strong params) and accessed directly via `params[:debt][:counterparty_personal_id]` in the controller
---

## 2026-02-11 - US-021
- What was implemented: Built debt detail page with full status display, installment schedule, payment history, and witness section. Enhanced DebtsController#show with authorization (before_action) checking lender, borrower, or confirmed witness access — unauthorized users redirected to debts_path with alert flash. Show action explicitly renders `debts/Show` Inertia component with serialized props: debt overview (mode, status, amount, currency, deadline, installment type, lender/borrower names), installments (ordered by due_date), payments (with submitter name, rejection reason), and witnesses (with status). Created pages/debts/Show.tsx with status badges (color-coded per status), debt overview card (lender, borrower, amount, deadline, installment type, description, created date), installment table (with overdue highlighting in red), payment history list (with rejection reason display), witness list (with status badges), Quranic witness reminder (strong for personal mode, standard for mutual, hidden when confirmed witnesses exist), and Ayat al-Dayn verse banner. Added i18n translations for entire debt detail page in en.json and ar.json. Added `debts.unauthorized` translations in en.yml and ar.yml. Added third user fixture (`users(:three)`) and confirmed witness fixture for test coverage. Wrote 4 controller tests: lender can view, borrower can view, unauthorized user redirected, confirmed witness can view.
- Files changed: app/controllers/debts_controller.rb (modified), app/frontend/pages/debts/Show.tsx (new), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/locales/en.yml (modified), config/locales/ar.yml (modified), test/controllers/debts_controller_test.rb (modified), test/fixtures/users.yml (modified), test/fixtures/witnesses.yml (modified)
- **Learnings for future iterations:**
  - DebtsController#show cannot rely on `default_render: true` when it needs to serialize associations — must use explicit `render inertia:` with `props:` hash
  - Authorization check uses `before_action` pattern with redirect instead of raising exceptions — consistent with InertiaController redirect-based error handling
  - Confirmed witnesses are checked via `@debt.witnesses.confirmed.exists?(user_id: current_user.id)` — uses the enum scope from the Witness model
  - Show.tsx page component naming: `render inertia: "debts/Show"` maps to `pages/debts/Show.tsx` — capital S matters
  - Installment overdue detection on frontend: compare due_date with today's date for `upcoming` status installments that are past their due date
  - StatusBadge component uses a variants map for color-coded badges — reusable pattern for consistent status display across pages
---

## 2026-02-11 - US-022
- What was implemented: Implemented borrower confirmation flow for mutual debts. The backend (controller actions, routes, authorization, notifications) was already scaffolded in US-021 — this story completed the frontend UI. Added ConfirmationBanner component to Show.tsx that displays when debt is pending and current user is the confirming party (non-creator), with Confirm and Reject buttons using Inertia router.post. Added AwaitingConfirmation component showing "Awaiting confirmation from [name]" message when debt is pending and current user is the creator. Both components handle loading states. Added Arabic i18n translations for the confirmation section (already existed in en.json). Wrote 4 controller tests: non-creator confirms (debt becomes active with installments + notification), non-creator rejects (debt becomes rejected + notification), creator cannot confirm own debt, already active debt cannot be confirmed again.
- Files changed: app/frontend/pages/debts/Show.tsx (modified — added ConfirmationBanner, AwaitingConfirmation components, added is_confirming_party/is_creator props), app/frontend/i18n/locales/ar.json (modified — added debt_detail.confirmation translations), test/controllers/debts_controller_test.rb (modified — added 4 confirm/reject tests)
- **Learnings for future iterations:**
  - Backend for confirm/reject was already scaffolded as part of US-021 Show implementation — the controller had `confirm` and `reject` actions, routes had member routes, and `is_confirming_party`/`is_creator` props were already passed to the page
  - ConfirmationBanner uses `router.post` with empty data `{}` since confirm/reject don't need request body
  - The confirming party is the non-creator: if creator_role is "lender", the borrower confirms; if "borrower", the lender confirms
  - Arabic confirmation translations were missing from ar.json even though en.json had them — always check both locale files when translations are expected
---

## 2026-02-11 - US-023
- What was implemented: Implemented payment submission for debt detail page. Created PaymentsController with create action inheriting from InertiaController. Mutual mode: creates payment with status 'pending', notifies lender via Notification. Personal mode: creates payment with status 'approved' (auto-approved, self-reported). Added remaining balance validation to Payment model (amount cannot exceed debt.amount minus approved payments sum). Added authorization: only borrower can submit on mutual debts, only creator (lender_id) can submit on personal debts. Only active debts accept payments. Added nested routes: `resources :payments, only: [:create]` under debts. Updated DebtsController#show to pass `is_borrower` and `remaining_balance` props. Updated Show.tsx with SubmitPaymentDialog component using shadcn Dialog with amount, description, and optional installment link fields. Client-side validation for positive amount and remaining balance check. Submit Payment button visible only to borrower on active debts with remaining balance > 0. Added i18n translations for all payment submission UI text (en/ar) and Rails flash messages (en.yml/ar.yml). Wrote 6 controller tests.
- Files changed: app/controllers/payments_controller.rb (new), app/controllers/debts_controller.rb (modified — added is_borrower/remaining_balance props, borrower_for_debt?/remaining_balance helpers), app/models/payment.rb (modified — added amount_within_remaining_balance validation), app/frontend/pages/debts/Show.tsx (modified — added SubmitPaymentDialog, new props, Dialog/Input/Label/Select/Textarea imports), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/locales/en.yml (modified), config/locales/ar.yml (modified), config/routes.rb (modified), test/controllers/payments_controller_test.rb (new)
- **Learnings for future iterations:**
  - PaymentsController uses nested routes: `debt_payments_url(debt)` for POST /debts/:debt_id/payments
  - Payment remaining balance: `debt.amount - debt.payments.approved.sum(:amount)` — no separate balance column needed
  - Personal mode payments are auto-approved (status 'approved') with no notification; mutual mode payments are 'pending' with lender notification
  - Personal mode borrower check: `@debt.lender_id == current_user.id` since lender_id is always the creator in personal mode
  - Payment model validation `on: :create` ensures balance check only applies to new payments, not status updates
  - shadcn Select with "none" value: must explicitly check `installmentId !== 'none'` before sending to server, as `"none"` is truthy
  - Vite test manifest becomes stale after TypeScript changes — force rebuild with `RAILS_ENV=test bin/vite build --force`
---

## 2026-02-11 - US-024
- What was implemented: Implemented payment approval and auto-settlement. Added approve and reject member routes on payments. Extended PaymentsController with approve action (sets status to approved, marks linked installment as approved if fully covered, notifies borrower) and reject action (sets status to rejected with optional rejection_reason, notifies borrower). Added auto-settlement logic: after any payment approval (or auto-approved personal mode payment), checks if total approved payments >= debt amount and transitions debt to 'settled' status with settlement notifications for both parties. Added is_lender prop to DebtsController#show. Updated Show.tsx with PaymentActions component showing Approve (green) and Reject (red) buttons on pending payments visible only to the lender on mutual debts. Reject opens a dialog for optional rejection reason. PaymentStatusBadge now uses translated labels. Added i18n translations for payment approval/rejection UI (en/ar) and Rails backend messages including payment_approved, payment_rejected, debt_settled notifications. Wrote 4 controller tests: lender approves payment, lender rejects with reason, approval triggers auto-settlement, borrower cannot approve.
- Files changed: app/controllers/payments_controller.rb (modified), app/controllers/debts_controller.rb (modified — added is_lender prop), app/frontend/pages/debts/Show.tsx (modified — added PaymentActions component, is_lender prop, translated PaymentStatusBadge), config/routes.rb (modified — added approve/reject member routes on payments), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), config/locales/en.yml (modified), config/locales/ar.yml (modified), test/controllers/payments_controller_test.rb (modified — added 4 tests)
- **Learnings for future iterations:**
  - Payment approve/reject routes are nested member routes: `approve_debt_payment_url(debt, payment)` → POST /debts/:debt_id/payments/:id/approve
  - Auto-settlement check: `remaining_balance <= 0` after every approval — uses same `remaining_balance` helper as payment creation
  - Installment marking: when a payment linked to an installment is approved, check if total approved payments for that installment >= installment amount, then mark installment as 'approved'
  - Settlement notifications go to both lender and borrower via `[@debt.lender, @debt.borrower].compact.each`
  - Personal mode auto-settlement: also checked after create (since personal mode payments are auto-approved)
  - PaymentStatusBadge should use translated labels via `t('debt_detail.payments.status_${status}')` for i18n consistency
---

## 2026-02-11 - US-025
- What was implemented: Implemented witness assignment for debt detail page. Created WitnessesController with create, confirm, and decline actions inheriting from InertiaController. Create action: accepts Personal ID, looks up user, creates witness with status 'invited', sends notification to witness. Enforces max 2 witnesses per debt, prevents duplicate invitations, prevents self-invitation. Only the debt creator can invite witnesses on non-settled/rejected debts. Confirm action: only the invited witness user can confirm, sets status to 'confirmed' with confirmed_at timestamp, notifies debt creator. Decline action: only the invited witness user can decline, sets status to 'declined', notifies debt creator. Added nested routes under debts for witnesses (create, confirm, decline member routes). Updated DebtsController#show to pass `can_manage_witnesses` and `is_invited_witness` props. Updated Show.tsx with AddWitnessForm component (Personal ID input with auto-lookup at 6 chars, invite button, max-reached message) and WitnessActions component (Accept/Decline buttons for invited witnesses). Witness list now shows Accept/Decline buttons inline for the invited witness user instead of status badge. Added all i18n translations for witness management in en.json, ar.json, en.yml, ar.yml (flash messages, notification messages, UI labels). Added fourth user fixture for test scenarios. Wrote 10 controller tests covering invite success, max 2 enforcement, duplicate prevention, self-invite prevention, non-creator restriction, witness confirm, witness decline, non-invited user restriction, already-responded restriction. Fixed pre-existing rubocop offense in DebtsController (redundant return).
- Files changed: app/controllers/witnesses_controller.rb (new), app/controllers/debts_controller.rb (modified — added can_manage_witnesses?, invited_witness_id helpers, fixed rubocop offense), app/frontend/pages/debts/Show.tsx (modified — added AddWitnessForm, WitnessActions components, new props), config/routes.rb (modified — added nested witness routes), app/frontend/i18n/locales/en.json (modified — added witness management translations), app/frontend/i18n/locales/ar.json (modified — added witness management translations), config/locales/en.yml (modified — added witnesses and notification translations), config/locales/ar.yml (modified — added witnesses and notification translations), test/fixtures/users.yml (modified — added fourth user fixture), test/controllers/witnesses_controller_test.rb (new — 10 tests)
- **Learnings for future iterations:**
  - WitnessesController nested routes: `debt_witnesses_url(debt)` for create, `confirm_debt_witness_url(debt, witness)` and `decline_debt_witness_url(debt, witness)` for member actions
  - Max witnesses enforced at controller level with `@debt.witnesses.count >= 2` check, not at model level — allows flexibility
  - `can_manage_witnesses` prop combines creator check AND debt status check (not settled/rejected) — simplifies frontend logic
  - `is_invited_witness` prop returns the witness ID (or null) so the frontend can show Accept/Decline buttons for the specific witness row
  - Witness confirm/decline authorization: check `@witness.user_id == current_user.id` AND `@witness.invited?` to prevent double-respond
  - Personal ID lookup in witness form reuses the same `/users/lookup` endpoint from debt creation (US-019)
  - Fourth user fixture `users(:four)` with personal_id KMN345 added for witness tests requiring a user not already involved in existing fixtures
---

## 2026-02-11 - US-026
- What was implemented: Built debt dashboard with per-currency summaries. Created DashboardController with index action inheriting from InertiaController. Query logic: for each currency the user has active/settled debts in, calculates total lent, total borrowed, total approved payments, remaining balance, next upcoming installment, active/settled counts. Includes both Mutual and Personal debts with proper role detection (personal mode borrower via creator_role). GET /dashboard renders dashboard/Index Inertia component. Updated authenticated root route from home#index to dashboard#index. Added dedicated /dashboard route. Dashboard shows summary Card per currency with lent/borrowed/paid/remaining amounts, next installment info, and active/settled counts. Recent debts section shows 5 most recent non-rejected debts with counterparty name, amount, status badge, linked to debt detail. New Debt CTA button linking to /debts/new. Empty state for users with no debts: Ayat al-Dayn welcome message with verse excerpt and Create Your First Debt button. Updated app-layout nav dashboard link to /dashboard with isActive handling for both / and /dashboard. All text translated (en/ar). Wrote 5 controller tests: empty state, single currency, multiple currencies, authenticated root, authentication requirement. 144 tests pass, 0 failures.
- Files changed: app/controllers/dashboard_controller.rb (new), app/frontend/pages/dashboard/Index.tsx (new), test/controllers/dashboard_controller_test.rb (new), app/frontend/i18n/locales/en.json (modified), app/frontend/i18n/locales/ar.json (modified), app/frontend/layouts/app-layout.tsx (modified), config/routes.rb (modified)
- **Learnings for future iterations:**
  - DashboardController uses explicit `render inertia: "dashboard/Index", props: { ... }` since it needs custom data aggregation (not default_render)
  - Per-currency summaries query active+settled debts, then group by currency — pending/rejected excluded from financial summaries
  - Personal mode borrowed total: query `lender_id == current_user.id AND mode == personal AND creator_role == borrower` since personal debts always set lender_id to current_user
  - Remaining balance calculation: `max(lent + borrowed - paid, 0)` — uses max to avoid negative values from rounding
  - Recent debts exclude rejected debts (`where.not(status: "rejected")`) ordered by created_at desc, limit 5
  - Nav dashboard link changed from `/` to `/dashboard` — isActive check must handle both paths for correct highlighting
  - Authenticated root in devise_scope now points to `dashboard#index` — the old `home#index` fallback root at bottom of routes still exists but is shadowed
---

## 2026-02-11 - US-027
- What was implemented: Built debts list page with filtering and sorting. Enhanced DebtsController#index to query all debts where current_user is lender or borrower, with support for URL query params: status (all/pending/active/settled/rejected), mode (all/mutual/personal), role (all/lender/borrower), and sort (created_at_desc/deadline_asc/amount_desc). Each debt row includes a progress bar showing approved payments as percentage of total amount. Created pages/debts/Index.tsx with filter dropdowns (using shadcn Select), sort selector, debt rows with counterparty name, amount+currency, status badge, mode badge, deadline, progress bar, and empty state message. Clicking a debt navigates to /debts/:id. Added all i18n translations for debts list (en/ar). Wrote 4 controller tests: index returns user's debts, filter by status, filter by mode, sort by deadline. 148 tests pass, 0 failures.
- Files changed: app/controllers/debts_controller.rb (modified — added index query logic, filtering, sorting, JSON serialization), app/frontend/pages/debts/Index.tsx (new), app/frontend/i18n/locales/en.json (modified — added debts_list section), app/frontend/i18n/locales/ar.json (modified — added debts_list section), test/controllers/debts_controller_test.rb (modified — added 4 index tests)
- **Learnings for future iterations:**
  - DebtsController#index uses explicit `render inertia: "debts/Index"` with `props:` hash — not `default_render` since it needs custom filtering/sorting
  - Filter URL params: `router.get()` with `preserveState: true, replace: true` updates URL params and triggers Inertia page refresh without full navigation
  - Progress bar calculation: `(approved_payments_sum / debt.amount * 100).round(1)` — computed server-side and passed as `progress` prop
  - RuboCop doesn't like `case` assigned to a variable with `when` indented differently from the `case` keyword — extract to a separate method for cleaner code
  - `user_debts` query pattern: `Debt.where(lender_id:).or(Debt.where(borrower_id:))` — same pattern used in DashboardController
---

## 2026-02-11 - US-028
- What was implemented: Created centralized NotificationService and notifications backend. Created app/services/notification_service.rb as a service class with class methods for all notification types: debt_created, debt_confirmed, debt_rejected, payment_submitted, payment_approved, payment_rejected, witness_invited, witness_confirmed, witness_declined, debt_settled. Each method creates a Notification record with the appropriate user_id, notification_type, translatable message, and debt_id. Created NotificationsController with index (renders notifications/Index Inertia page), mark_read (POST /notifications/:id/mark_read sets read: true), and mark_all_read (POST /notifications/mark_all_read sets all unread to read). Added notification routes with member mark_read and collection mark_all_read actions. Shared unread notification count via inertia_share in InertiaController (available to all pages for header bell). Refactored all existing controllers (DebtsController, PaymentsController, WitnessesController) to use NotificationService instead of inline Notification.create! calls — removed ~145 lines of duplicated notification code. Added Rails locale translations for notifications_page (marked_read, all_marked_read) in en.yml and ar.yml. Wrote 4 controller tests for NotificationsController (index, mark_read, mark_all_read, authentication) and 11 service tests for NotificationService covering all notification types. 162 tests pass, 0 failures.
- Files changed: app/services/notification_service.rb (new), app/controllers/notifications_controller.rb (new), app/controllers/debts_controller.rb (modified — replaced inline notifications with NotificationService calls, removed notify_* private methods), app/controllers/payments_controller.rb (modified — replaced inline notifications with NotificationService calls, removed notify_* private methods), app/controllers/witnesses_controller.rb (modified — replaced inline notifications with NotificationService calls, removed notify_* private methods), app/controllers/inertia_controller.rb (modified — added unread_notifications_count to inertia_share), config/routes.rb (modified — added notifications routes), config/locales/en.yml (modified — added notifications_page section), config/locales/ar.yml (modified — added notifications_page section), test/controllers/notifications_controller_test.rb (new), test/services/notification_service_test.rb (new)
- **Learnings for future iterations:**
  - NotificationService uses class methods (not instance) — call via `NotificationService.debt_created(debt)`, no need to instantiate
  - NotificationsController uses `update_all` for mark_all_read — requires `rubocop:disable Rails/SkipsModelValidations` comment since it bypasses Active Record callbacks
  - `unread_notifications_count` shared via `current_user&.notifications&.unread&.count || 0` — safe navigation handles nil current_user on unauthenticated pages
  - Refactoring notifications from controllers to service: some notification methods (like debt_created) derive the creator from the debt model itself (via creator_role), while the controller previously used `current_user` — the service approach is more self-contained but the trade-off is it reads from the model rather than the request context
  - witness_declined notification was being sent by the original code but wasn't listed in the PRD acceptance criteria — added it to NotificationService to maintain existing behavior and pass existing tests
---

## 2026-02-11 - US-029
- What was implemented: Built notifications page UI and header bell icon with unread count badge. Created pages/notifications/Index.tsx with a list of all notifications ordered newest first. Each notification shows an icon by type (different lucide-react icons for debt/payment/witness/settlement events), message text, relative time using Intl.RelativeTimeFormat, and read/unread visual indicator (bold for unread, small blue dot badge). Clicking a notification marks it as read (POST /notifications/:id/mark_read) and navigates to the related debt page. "Mark all as read" button at the top of the list (visible when there are unread notifications). Empty state with BellOff icon and message. Updated app-layout.tsx header: added Bell icon link to /notifications with unread count badge (red destructive Badge with number, hidden when count is 0). Badge supports RTL positioning. Read `unread_notifications_count` from shared Inertia props (already shared by InertiaController from US-028). Added i18n translations for notifications page UI in en.json and ar.json (notifications_page section: title, mark_all_read, empty).
- Files changed: app/frontend/pages/notifications/Index.tsx (new), app/frontend/layouts/app-layout.tsx (modified — added Bell icon link with unread badge, Badge import, unread count from shared props), app/frontend/i18n/locales/en.json (modified — added notifications_page section), app/frontend/i18n/locales/ar.json (modified — added notifications_page section)
- **Learnings for future iterations:**
  - `unread_notifications_count` from InertiaController shared props is accessed via `(props as unknown as { unread_notifications_count?: number }).unread_notifications_count` — cast through unknown to avoid TS incompatibility with SharedData generic
  - Notification type icons map: use a const Record mapping notification_type strings to JSX elements with different lucide-react icons and colors per event type
  - `Intl.RelativeTimeFormat` with `numeric: 'auto'` gives natural relative times (e.g., "yesterday" instead of "1 day ago") — locale-aware for Arabic/English
  - Notification click flow: POST mark_read first, then on success navigate to debt page — ensures read state is updated before navigation
  - Badge positioning for RTL: use `ltr:-right-0.5 rtl:-left-0.5` Tailwind utilities for the notification count badge on the Bell icon
---

## 2026-02-11 - US-030
- What was implemented: Created DebtMailer for email notifications with 7 email methods (debt_created, debt_confirmed, payment_submitted, payment_approved, payment_rejected, witness_invitation, debt_settled). Each email includes greeting with recipient's full_name, event description, debt summary (amount, currency, counterparty), and link to debt detail page. Emails rendered in recipient's preferred locale via I18n.with_locale(recipient.locale). Created both HTML and text ERB view templates in app/views/debt_mailer/ for all 7 email types. Integrated with NotificationService: each relevant notification method now enqueues the corresponding mailer via deliver_later. Not all notifications send emails — debt_rejected, witness_confirmed, and witness_declined are in-app only. Added i18n translations for all email subjects and body text in en.yml and ar.yml (debt_mailer section), plus date format translations. Wrote 11 mailer tests covering all email types, correct recipient, locale handling (Arabic and English), and personal debt counterparty_name usage. 173 tests total pass with 0 failures.
- Files changed: app/mailers/debt_mailer.rb (new), app/views/debt_mailer/*.html.erb (7 new), app/views/debt_mailer/*.text.erb (7 new), app/services/notification_service.rb (modified — added deliver_later calls), config/locales/en.yml (modified — added debt_mailer translations), config/locales/ar.yml (modified — added debt_mailer translations), test/mailers/debt_mailer_test.rb (new)
- **Learnings for future iterations:**
  - Mailer tests with non-ASCII locales (Arabic): email body is base64-encoded — use `email.text_part.body.decoded` instead of `email.body.encoded` to match content
  - `OpenStruct` requires explicit `require "ostruct"` in files with `frozen_string_literal: true` — use `Struct.new(:full_name).new(value)` as a simpler alternative
  - `I18n.with_locale(locale) { mail(...) }` ensures the entire email (subject + body) renders in the recipient's preferred language
  - Date localization in emails: `l(@debt.deadline, format: :long)` requires `date.formats.long` to be defined in both en.yml and ar.yml
  - Not all notification types warrant an email — debt_rejected, witness_confirmed, witness_declined are low-urgency and better as in-app only
  - `ApplicationMailer` default `from:` is `"from@example.com"` — should be updated before production
---

## 2026-02-11 - US-031
- What was implemented: Replaced Solid Queue with GoodJob for background jobs. Removed solid_queue gem and added good_job gem. Ran `rails generate good_job:install` to create migration, ran `db:migrate`. Configured GoodJob as Active Job backend in config/application.rb (`config.active_job.queue_adapter = :good_job`). Mounted GoodJob dashboard at /good_job in routes.rb. Removed Solid Queue config files (config/queue.yml, config/recurring.yml, db/queue_schema.rb, bin/jobs). Removed solid_queue Puma plugin reference from config/puma.rb. Removed queue database config from database.yml (GoodJob uses primary PG). Updated production.rb to use :good_job adapter. Set test environment to use :test adapter explicitly. Created InstallmentReminderJob that finds upcoming installments due in 3 days, 1 day, or today — creates in-app notification and sends email to both lender and borrower. Created OverdueDetectionJob that marks past-due upcoming installments as overdue, creates notifications, and sends emails. Added installment_reminder and overdue_notice methods to DebtMailer with HTML/text templates. Configured GoodJob cron schedule in config/initializers/good_job.rb: OverdueDetectionJob daily at midnight UTC, InstallmentReminderJob daily at 8 AM UTC. Added i18n translations for installment_reminder and installment_overdue notification messages and email subjects/bodies (en.yml and ar.yml). Wrote 11 job tests: 6 for InstallmentReminderJob (3-day, 1-day, today reminders, no reminders for far-future, no reminders for overdue, both parties notified) and 5 for OverdueDetectionJob (marks overdue + notifies, no re-processing, future safe, personal debt handling, correct users). 184 tests pass, 0 failures.
- Files changed: Gemfile (modified), Gemfile.lock (modified), app/jobs/installment_reminder_job.rb (new), app/jobs/overdue_detection_job.rb (new), app/mailers/debt_mailer.rb (modified — added installment_reminder and overdue_notice), app/views/debt_mailer/installment_reminder.{html,text}.erb (new), app/views/debt_mailer/overdue_notice.{html,text}.erb (new), config/application.rb (modified), config/database.yml (modified — removed queue DB), config/environments/production.rb (modified — :good_job), config/environments/test.rb (modified — :test adapter), config/initializers/good_job.rb (new), config/locales/en.yml (modified), config/locales/ar.yml (modified), config/puma.rb (modified), config/routes.rb (modified — mounted GoodJob), db/migrate/20260211110207_create_good_jobs.rb (new), db/schema.rb (updated), test/jobs/installment_reminder_job_test.rb (new), test/jobs/overdue_detection_job_test.rb (new). Deleted: bin/jobs, config/queue.yml, config/recurring.yml, db/queue_schema.rb
- **Learnings for future iterations:**
  - GoodJob uses primary PostgreSQL database — no separate queue database needed (unlike Solid Queue which had a dedicated queue DB)
  - `config.active_job.queue_adapter = :good_job` in application.rb applies to ALL environments — must explicitly set `:test` in test.rb for `assert_enqueued_jobs` etc.
  - `assert_enqueued_emails` requires `include ActionMailer::TestHelper` in `ActiveJob::TestCase` subclasses
  - GoodJob cron config uses standard cron syntax: `"0 0 * * *"` for midnight, `"0 8 * * *"` for 8 AM
  - GoodJob dashboard is mounted as a Rails engine: `mount GoodJob::Engine, at: "good_job"` — should be protected in production
  - Auto-generated GoodJob migration needs `rubocop -a` to fix Rails omakase bracket spacing
  - Installment `.upcoming` scope (from enum) filters only status=upcoming — overdue installments are NOT picked up by reminder job
---
