{
  "project": "Faktubuh",
  "branchName": "ralph/faktubuh-mvp",
  "description": "Faktubuh MVP — Bilingual (Arabic/English) peer-to-peer Islamic debt tracking app. Convert from Hotwire to Inertia.js + React + TypeScript + Vite + shadcn/ui, then build the full debt lifecycle end-to-end.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Remove Hotwire and add Inertia/Vite/React gems and packages",
      "description": "As a developer, I need the Hotwire dependencies removed and Inertia/Vite/React dependencies added so the project is ready for the new stack.",
      "acceptanceCriteria": [
        "Remove turbo-rails, stimulus-rails, jsbundling-rails, and cssbundling-rails from Gemfile",
        "Add inertia_rails (~> 3.6), vite_rails (~> 3.0), and js-routes gems to Gemfile",
        "Replace Hotwire packages in package.json with: react (^19), react-dom (^19), @inertiajs/react (^2), typescript, vite, @vitejs/plugin-react, vite-plugin-ruby, @tailwindcss/vite",
        "Run bundle install and yarn install successfully with no errors",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Reference ../react-starter-kit/Gemfile and ../react-starter-kit/package.json for exact versions."
    },
    {
      "id": "US-002",
      "title": "Configure Vite, TypeScript, and Inertia frontend entry point",
      "description": "As a developer, I need Vite, TypeScript, and the Inertia entry point configured so the frontend build pipeline works.",
      "acceptanceCriteria": [
        "Create vite.config.ts with React plugin (with babel-plugin-react-compiler), @tailwindcss/vite plugin, and vite-plugin-ruby",
        "Create tsconfig.json, tsconfig.app.json, tsconfig.node.json with @/* path alias pointing to app/frontend/*. Reference ../react-starter-kit/tsconfig*.json for exact settings",
        "Create app/frontend/entrypoints/inertia.tsx with createInertiaApp setup using import.meta.glob for page resolution and a default PersistentLayout wrapper",
        "Create app/frontend/layouts/persistent-layout.tsx that renders children (minimal wrapper for now)",
        "Create app/frontend/entrypoints/application.css with @import 'tailwindcss' and CSS variable theme (reference ../react-starter-kit/app/frontend/entrypoints/application.css)",
        "Create app/frontend/lib/utils.ts with cn() utility function using clsx + tailwind-merge",
        "Create app/frontend/types/index.ts with interfaces: User { id: number; full_name: string; email: string; personal_id: string; locale: string; created_at: string; updated_at: string }, Auth { user: User }, SharedData { auth: Auth; locale: string; flash?: { notice?: string; alert?: string } }",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Mirror the ../react-starter-kit patterns exactly. The PersistentLayout will be enhanced later."
    },
    {
      "id": "US-003",
      "title": "Configure Rails for Inertia and verify setup",
      "description": "As a developer, I need the Rails side configured for Inertia so pages render correctly through the new stack.",
      "acceptanceCriteria": [
        "Update app/views/layouts/application.html.erb to use vite_stylesheet_tag 'application', vite_client_tag, and vite_typescript_tag 'inertia.tsx'. Remove old stylesheet/javascript tags",
        "Create app/controllers/inertia_controller.rb inheriting from ApplicationController with inertia_config default_render: true",
        "Create config/initializers/inertia_rails.rb with ViteRuby.digest versioning, use_script_element_for_initial_page: true, and parent_controller: '::InertiaController'",
        "Configure js-routes gem: create config/initializers/js_routes.rb to generate TypeScript route helpers (reference ../react-starter-kit/config/initializers/js_routes.rb)",
        "Remove app/javascript/ directory entirely",
        "Update Procfile.dev to use 'bin/vite dev' instead of esbuild and css watch commands",
        "Create app/frontend/pages/home/index.tsx that renders 'Faktubuh' heading",
        "Add root route in config/routes.rb pointing to a HomeController#index (inheriting InertiaController)",
        "bin/dev starts successfully and the home page renders at localhost:3000",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 3,
      "passes": true,
      "notes": "This is the verification story — after this, Inertia + React is fully working."
    },
    {
      "id": "US-004",
      "title": "Install and configure shadcn/ui with base components",
      "description": "As a developer, I need shadcn/ui installed so all UI uses accessible, composable Radix UI primitives.",
      "acceptanceCriteria": [
        "Create components.json with style 'new-york', tsx: true, rsc: false, CSS variables enabled, aliases: @/components, @/components/ui, @/lib, @/hooks. Reference ../react-starter-kit/components.json",
        "Install shadcn dependencies: class-variance-authority, clsx, tailwind-merge, lucide-react, tw-animate-css",
        "Install shadcn/ui components: Button, Input, Label, Card, Badge, Dialog, Dropdown Menu, Select, Sheet, Avatar, Breadcrumb, Tooltip into app/frontend/components/ui/",
        "Create a test page or update home/index.tsx to render a Button and Card component to verify shadcn works",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Use 'npx shadcn@latest init' and 'npx shadcn@latest add' commands. Components are copied into the project."
    },
    {
      "id": "US-005",
      "title": "Configure bilingual i18n with Rails I18n and react-i18next",
      "description": "As a developer, I need bilingual infrastructure (Arabic RTL / English LTR) set up from the start so every page supports both languages.",
      "acceptanceCriteria": [
        "Add react-i18next and i18next packages to package.json",
        "Create app/frontend/i18n/config.ts that initializes i18next with language detection from locale shared via Inertia props",
        "Create app/frontend/i18n/locales/en.json and app/frontend/i18n/locales/ar.json with base UI translations (app name, common labels like Save, Cancel, Loading, etc.)",
        "Initialize i18next in the Inertia entry point (inertia.tsx)",
        "Set dir='rtl' and lang='ar' on <html> element when Arabic is active, dir='ltr' and lang='en' for English",
        "Create app/frontend/components/language-toggle.tsx that switches between Arabic and English",
        "Create Rails config/locales/en.yml and config/locales/ar.yml with base translations",
        "Add around_action :switch_locale in ApplicationController that reads locale from params, cookie, or Accept-Language header and sets I18n.locale",
        "Share current locale from Rails to Inertia via inertia_share in InertiaController",
        "Update the home page to use translated text and include the LanguageToggle. Verify switching between English and Arabic works",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Use Tailwind v4 built-in RTL utilities (rtl: and ltr: variants) rather than a separate plugin."
    },
    {
      "id": "US-006",
      "title": "Set up linting and test infrastructure",
      "description": "As a developer, I need linting and test coverage configured so code quality is enforced from the start.",
      "acceptanceCriteria": [
        "Create oxlint.json config file enabling TypeScript + React rules (reference oxlint docs for recommended ruleset)",
        "Add 'lint' script to package.json that runs oxlint on app/frontend/",
        "Add 'format' script to package.json that runs oxfmt on app/frontend/",
        "Update mise.toml lint task to run both Ruby (rubocop) and JS (oxlint) linters",
        "Add simplecov gem to test group in Gemfile",
        "Configure SimpleCov in test/test_helper.rb to start before anything loads, with 95% minimum coverage threshold",
        "Add coverage/ to .gitignore",
        "Create empty fixture files for planned models: users.yml, debts.yml, installments.yml, payments.yml, witnesses.yml, notifications.yml",
        "mise run test runs successfully and generates a coverage report in coverage/",
        "mise run lint runs successfully with no errors on existing files",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Install Devise and generate User model with migration",
      "description": "As a developer, I need Devise installed and the User model created with all required columns so authentication can be built.",
      "acceptanceCriteria": [
        "Add devise (~> 5.0), omniauth (~> 2.1), omniauth-google-oauth2 (~> 1.2), and omniauth-rails_csrf_protection (~> 2.0) gems to Gemfile and bundle install",
        "Run rails generate devise:install",
        "Run rails generate devise User with modules: database_authenticatable, registerable, recoverable, rememberable, validatable",
        "Add custom columns to the generated migration: personal_id (string, null: false), full_name (string, null: false), provider (string, nullable), uid (string, nullable), locale (string, default: 'en')",
        "Add unique index on personal_id column",
        "Add unique compound index on [provider, uid]",
        "Run rails db:migrate successfully",
        "User model file exists at app/models/user.rb with Devise modules",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Reference ../milkstraw/milkstraw-web-app/app/models/user.rb for Devise module configuration."
    },
    {
      "id": "US-008",
      "title": "Configure Devise for Inertia integration",
      "description": "As a developer, I need Devise configured to work with Inertia.js instead of traditional ERB views so auth forms render as React components.",
      "acceptanceCriteria": [
        "Create app/responders/inertia_devise_responder.rb that redirects with Inertia error props on form failures. Reference ../milkstraw/milkstraw-web-app/app/responders/inertia_devise_responder.rb",
        "Create app/controllers/devise/inertia_failure_app.rb that forces redirect-based auth flow for Inertia requests. Reference ../milkstraw/milkstraw-web-app/app/controllers/devise/inertia_failure_app.rb",
        "Configure Devise in config/initializers/devise.rb: set config.responder = InertiaDeviseResponder, config.responder.error_status = :unprocessable_content, config.responder.redirect_status = :see_other",
        "Configure Devise warden failure app: config.warden { |manager| manager.failure_app = Devise::InertiaFailureApp }",
        "Set config.sign_out_via = :delete",
        "Set config.navigational_formats = ['*/*', :html]",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "This story creates the Devise-Inertia glue layer. Controllers come in subsequent stories."
    },
    {
      "id": "US-009",
      "title": "Configure User model with Personal ID and concerns",
      "description": "As a developer, I need the User model fully configured with Personal ID generation, validations, and Devise concerns so users get unique IDs on registration.",
      "acceptanceCriteria": [
        "Add Devise modules to User model: :database_authenticatable, :registerable, :recoverable, :rememberable, :validatable, :omniauthable with omniauth_providers: [:google_oauth2]",
        "Add before_create callback that generates a 6-character alphanumeric Personal ID using characters A-Z, 2-9 (excluding 0, O, 1, I, L). Stored uppercase. Retries on collision (up to 10 attempts with unique constraint as final guard)",
        "Add validations: full_name presence, personal_id presence + uniqueness + format (/\\A[A-HJ-NP-Z2-9]{6}\\z/)",
        "Create app/models/concerns/devise_overrides.rb that overrides send_devise_notification to use deliver_later for async email delivery",
        "Create app/models/concerns/omniauth_concern.rb with User.from_omniauth(auth) class method that finds existing user by provider+uid or creates new user with data from OAuth response (email, full_name from auth.info.name, random password)",
        "Include both concerns in User model",
        "Write model tests: full_name presence validation, personal_id format validation, personal_id uniqueness, personal_id auto-generation on create, personal_id excludes ambiguous characters, from_omniauth creates new user, from_omniauth finds existing user",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Reference ../milkstraw/milkstraw-web-app/app/models/concerns/devise_overrides.rb and omniauth.rb"
    },
    {
      "id": "US-010",
      "title": "Implement Devise registration controller and sign-up page",
      "description": "As a user, I want to register with my email and full name so I can start tracking debts.",
      "acceptanceCriteria": [
        "Create app/controllers/users/registrations_controller.rb inheriting from Devise::RegistrationsController",
        "Override new action to render Inertia component 'auth/SignUp'",
        "Override create action: on success redirect to dashboard, on failure redirect back with errors via InertiaDeviseResponder",
        "Permit additional Devise params: :full_name in sign_up_params",
        "Create app/frontend/pages/auth/sign-up.tsx with form fields: Full Name, Email, Password, Password Confirmation",
        "Form uses Inertia useForm hook for state management and submission",
        "Validation errors display inline under each field",
        "All labels and messages use react-i18next translations (add to en.json and ar.json)",
        "Configure devise_for :users in routes.rb with controllers: { registrations: 'users/registrations' }",
        "After successful registration user is redirected to root path (dashboard)",
        "Integration test: successful registration creates user with Personal ID",
        "Integration test: registration with missing full_name returns errors",
        "Integration test: registration with duplicate email returns errors",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement Devise login/logout controller and sign-in page",
      "description": "As a registered user, I want to log in with my email and password so I can access my debts.",
      "acceptanceCriteria": [
        "Create app/controllers/users/sessions_controller.rb inheriting from Devise::SessionsController",
        "Override new action to render Inertia component 'auth/SignIn'",
        "Create app/frontend/pages/auth/sign-in.tsx with form fields: Email, Password, Remember Me checkbox",
        "Form uses Inertia useForm hook for state management and submission",
        "Invalid credentials show generic error message without revealing which field is wrong",
        "Add sessions: 'users/sessions' to devise_for controller mappings",
        "Configure devise_scope: authenticated root points to 'home#index' (placeholder until DashboardController is built in US-026, which will update this to 'dashboard#index'), unauthenticated root points to 'users/sessions#new'",
        "Add before_action :authenticate_user! to InertiaController (all authenticated pages require login)",
        "DELETE /users/sign_out clears session and redirects to sign-in page",
        "All labels and messages translated (en/ar)",
        "Integration test: successful login redirects to dashboard",
        "Integration test: invalid credentials show error",
        "Integration test: logout clears session",
        "Integration test: unauthenticated user redirected to sign-in",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 11,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Implement Google OAuth 2.0 login",
      "description": "As a user, I want to sign up or log in with my Google account for convenience.",
      "acceptanceCriteria": [
        "Configure OmniAuth Google strategy in config/initializers/devise.rb using Rails.application.credentials for client_id and client_secret",
        "Create app/controllers/users/omniauth_callbacks_controller.rb inheriting from Devise::OmniauthCallbacksController",
        "Implement google_oauth2 method that calls User.from_omniauth(request.env['omniauth.auth']), signs in the user, and redirects to root path",
        "Handle OAuth failure by redirecting to sign-in with flash error",
        "Add omniauth_callbacks: 'users/omniauth_callbacks' to devise_for controller mappings",
        "Add 'Sign in with Google' button to both sign-in.tsx and sign-up.tsx pages. Button posts to /users/auth/google_oauth2",
        "All button text and error messages translated (en/ar)",
        "Integration test: OAuth callback with new user creates account",
        "Integration test: OAuth callback with existing user signs in",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 12,
      "passes": true,
      "notes": "For test environment, mock the OmniAuth response using OmniAuth.config.test_mode = true."
    },
    {
      "id": "US-013",
      "title": "Build main app layout with navigation",
      "description": "As a user, I want a consistent app layout with navigation, language toggle, and user menu so I can access all features easily.",
      "acceptanceCriteria": [
        "Create app/frontend/layouts/app-layout.tsx with header, main content area, and optional sidebar",
        "Header shows: app name 'Faktubuh' (فاكتبوه in Arabic mode), LanguageToggle component, user avatar/name dropdown menu",
        "User dropdown menu items: Profile, Logout (using Inertia Link/router for navigation)",
        "Navigation links: Dashboard, My Debts, Notifications. Use generated js-routes helpers for paths",
        "Active navigation link is visually highlighted based on current URL",
        "Layout is fully responsive: mobile shows hamburger menu that opens a Sheet/sidebar overlay",
        "RTL layout mirrors correctly: nav items, icons, text alignment all flip for Arabic",
        "Share current_user data via inertia_share in InertiaController: auth: { user: current_user.as_json(only: [:id, :full_name, :email, :personal_id]) } — guard with 'if current_user' since unauthenticated pages (sign-in, sign-up) also use InertiaController indirectly",
        "All navigation text translated (en/ar)",
        "Update pages/home/index.tsx (or pages/dashboard/index.tsx placeholder) to use the app-layout",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Use shadcn/ui Sheet for mobile menu, DropdownMenu for user menu. This layout wraps all authenticated pages."
    },
    {
      "id": "US-014",
      "title": "Build user profile page",
      "description": "As a user, I want to see my profile with my Personal ID and a way to share it so others can find me on the platform.",
      "acceptanceCriteria": [
        "Create app/controllers/profiles_controller.rb with show and update actions, inheriting from InertiaController",
        "GET /profile renders pages/profile/show.tsx",
        "Profile page displays: full name (editable text input), email (read-only), Personal ID (read-only, displayed prominently in large monospaced font)",
        "Personal ID has a copy-to-clipboard button that copies the ID and shows a success toast",
        "Personal ID has a share button using Web Share API (navigator.share) where supported, fallback to copy",
        "Update Name form uses Inertia useForm hook, PATCH /profile, shows success toast on save",
        "Name update validates full_name presence and shows inline error if empty",
        "Add routes: resource :profile, only: [:show, :update]",
        "All text translated (en/ar), layout works in both RTL and LTR",
        "Controller test: profile show returns current user data",
        "Controller test: profile update changes full_name",
        "Controller test: profile update with blank name returns error",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create Debt model with migration and validations",
      "description": "As a developer, I need the Debt model so debt records can be stored and validated.",
      "acceptanceCriteria": [
        "Create migration for debts table with columns: lender_id (bigint FK to users, not null), borrower_id (bigint FK to users, nullable), counterparty_name (string, nullable), mode (not null), creator_role (not null), amount (decimal precision 15 scale 2, not null), currency (string limit 3, not null), description (text, nullable), deadline (date, not null), installment_type (not null), status (not null, default 'pending'), timestamps",
        "Use PostgreSQL enum types for mode (mutual/personal), creator_role (lender/borrower), installment_type (lump_sum/monthly/bi_weekly/quarterly/yearly/custom_split), status (pending/active/settled/rejected)",
        "Add foreign key constraints on lender_id and borrower_id",
        "Add indexes on: status, lender_id, borrower_id, [lender_id, status], [borrower_id, status]",
        "Debt model has: belongs_to :lender (class_name: 'User'), belongs_to :borrower (class_name: 'User', optional: true), has_many :installments, has_many :payments, has_many :witnesses",
        "Validations: amount > 0, currency presence, deadline presence. Custom validation: mutual mode requires borrower_id present, personal mode requires counterparty_name present",
        "Add enum declarations for mode, creator_role, installment_type, status",
        "Run migration successfully",
        "Model tests: all validations, mutual mode requires borrower_id, personal mode requires counterparty_name, amount must be positive, associations",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Create Installment, Payment, Witness, and Notification models",
      "description": "As a developer, I need the remaining core models so the full debt lifecycle can be tracked.",
      "acceptanceCriteria": [
        "Create installments migration: debt_id (FK, not null), amount (decimal 15,2, not null), description (string, nullable), due_date (date, not null), status (enum: upcoming/submitted/approved/rejected/overdue, default upcoming), timestamps. Index on [debt_id, due_date]",
        "Create payments migration: debt_id (FK, not null), installment_id (FK, nullable), submitted_by (FK to users, not null), amount (decimal 15,2, not null), description (string, nullable), submitted_at (datetime, not null), status (enum: pending/approved/rejected, default pending), rejection_reason (text, nullable), timestamps. Index on [debt_id, status]",
        "Create witnesses migration: debt_id (FK, not null), user_id (FK, not null), status (enum: invited/confirmed/declined, default invited), confirmed_at (datetime, nullable), timestamps. Unique index on [debt_id, user_id]",
        "Create notifications migration: user_id (FK, not null), notification_type (string, not null), message (text, not null), read (boolean, default false, not null), debt_id (FK, nullable), timestamps. Index on [user_id, read]",
        "Installment model: belongs_to :debt, has_many :payments. Validations: amount > 0, due_date presence",
        "Payment model: belongs_to :debt, belongs_to :installment (optional), belongs_to :submitter (class_name: 'User', foreign_key: 'submitted_by'). Validations: amount > 0, submitted_at presence",
        "Witness model: belongs_to :debt, belongs_to :user. Validations: uniqueness of user_id scoped to debt_id",
        "Notification model: belongs_to :user, belongs_to :debt (optional). Scope :unread where read: false",
        "Run all migrations successfully",
        "Model tests for all validations, associations, and scopes",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 16,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Create InstallmentScheduleGenerator service",
      "description": "As a developer, I need a service that generates installment schedules from debt parameters so scheduled debts have concrete due dates.",
      "acceptanceCriteria": [
        "Create app/services/installment_schedule_generator.rb as a plain Ruby class",
        "Constructor accepts: debt (ActiveRecord object with amount, deadline, installment_type, created_at)",
        "Call method: generate! — creates Installment records for the debt",
        "Lump Sum: creates 1 installment for full amount due at deadline",
        "Monthly: divides amount into equal monthly installments from debt creation date to deadline. Last installment absorbs rounding remainder (e.g., $100 over 3 months = $33.33, $33.33, $33.34)",
        "Bi-weekly: same logic with 2-week intervals",
        "Quarterly: same logic with 3-month intervals",
        "Yearly: same logic with 12-month intervals",
        "Custom Split: creates no installments (returns empty array)",
        "Each installment has status 'upcoming'",
        "Unit tests for all 6 installment types",
        "Unit test: monthly with exact division (no remainder)",
        "Unit test: monthly with remainder (last installment absorbs it)",
        "Unit test: deadline very close to creation date (1 month away for monthly = 1 installment)",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 17,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Build debt creation UI — role and mode selection",
      "description": "As a user, I want to select my role (lender/borrower) and debt mode (Mutual/Personal) as the first step of creating a debt.",
      "acceptanceCriteria": [
        "Create app/controllers/debts_controller.rb with new action, inheriting from InertiaController",
        "GET /debts/new renders pages/debts/new.tsx",
        "Add routes: resources :debts, only: [:new, :create, :show, :index]",
        "Page displays a multi-step form. Step 1: two selectable cards — 'I'm lending' (with HandCoins icon) and 'I'm borrowing' (with HandHeart icon)",
        "Step 2: two selectable cards — 'Mutual' (both parties on platform, with Users icon) and 'Personal' (tracking on my own, with User icon). Each card has a brief description",
        "Selected card has a distinct visual highlight (border color, background, checkmark)",
        "Selections stored in React form state (not submitted yet — step 3 is US-019)",
        "A contextual Ayat al-Dayn verse snippet is displayed alongside the form in a subtle banner",
        "Next button advances to step 2 after role selection, and to step 3 (details form) after mode selection",
        "All text translated (en/ar), RTL layout correct",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Step 3 (counterparty and details form) is built in US-019. This story creates the multi-step form shell."
    },
    {
      "id": "US-019",
      "title": "Build debt creation form — counterparty, amount, and details",
      "description": "As a user, I want to specify the other party, amount, currency, deadline, and installment type to complete debt creation.",
      "acceptanceCriteria": [
        "Step 3 of the multi-step form in pages/debts/new.tsx adds the details form fields",
        "Mutual mode: text input for 6-character Personal ID. Create GET /users/lookup?personal_id=... endpoint in a UsersController that returns {id, full_name} or 404. On valid ID entry, show matched user's full name. On invalid, show 'User not found' error",
        "Personal mode: free-text input for counterparty name",
        "Amount field: numeric input (positive decimals only)",
        "Currency selector: searchable dropdown with 31 currencies — International: USD, EUR, GBP, CAD, AUD, CHF, JPY, CNY, INR. Arab/Islamic: SAR, AED, KWD, BHD, OMR, QAR, JOD, EGP, MAD, TND, DZD, LBP, IQD, SYP, LYD, SDG, YER, TRY, PKR, BDT, MYR, IDR. Display format: 'USD — US Dollar'",
        "Deadline field: date picker (must be in the future)",
        "Description field: optional textarea",
        "Installment type: radio group — Lump Sum, Monthly, Bi-weekly, Quarterly, Yearly, Custom Split. Each with a brief explanation",
        "Client-side validation: amount > 0, deadline in future, Personal ID not empty (mutual), counterparty name not empty (personal)",
        "All text translated (en/ar)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Form submission (POST /debts) is implemented in US-020. This story builds the UI and lookup endpoint."
    },
    {
      "id": "US-020",
      "title": "Implement debt creation backend",
      "description": "As a developer, I need the DebtsController#create action so debts are persisted with correct mode-specific logic.",
      "acceptanceCriteria": [
        "DebtsController#create action accepts all debt params via strong parameters",
        "Sets lender_id or borrower_id based on creator_role and current_user",
        "Mutual mode: creates debt with status 'pending'. Sets borrower_id (or lender_id) to the looked-up user from Personal ID. Creates a notification for the other party",
        "Personal mode: creates debt with status 'active'. Calls InstallmentScheduleGenerator to create installment schedule immediately",
        "On success: redirects to debt show page (GET /debts/:id)",
        "On validation failure: redirects back with errors via Inertia",
        "Wire up the form submission in pages/debts/new.tsx to POST /debts using Inertia router",
        "Integration test: create mutual debt as lender — debt pending, other party notified",
        "Integration test: create personal debt — debt active, installments generated",
        "Integration test: create debt with invalid params returns errors",
        "Integration test: mutual debt with invalid Personal ID returns error",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 20,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Build debt detail page",
      "description": "As a user, I want to see all details of a specific debt including status, installments, payments, and witnesses.",
      "acceptanceCriteria": [
        "DebtsController#show action loads debt with associated installments, payments, and witnesses",
        "Authorization: only the lender, borrower, or confirmed witnesses can view. Others get redirected with 403-equivalent flash. Use a before_action to check authorization",
        "Create pages/debts/show.tsx displaying: status badge (pending/active/settled/rejected with color coding), role labels (Lender: name, Borrower: name), amount and currency, deadline, description, installment type label, mode badge (mutual/personal)",
        "Installment schedule section: table/list of installments with columns — amount, due date, status badge. Overdue installments highlighted in red",
        "Payment history section: list of payments with — amount, date, status badge (pending=yellow, approved=green, rejected=red), description, rejection reason if rejected",
        "Witness section: list of witnesses with name and status badge (invited/confirmed/declined). If no witnesses: show Quranic compliance reminder. Personal mode with no witnesses: strong reminder. Mutual mode with no witnesses: standard reminder. With confirmed witnesses: no reminder",
        "Ayat al-Dayn verse snippet in a subtle banner/card on the page",
        "All text translated (en/ar)",
        "Controller test: authorized user can view debt",
        "Controller test: unauthorized user gets 403/redirect",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 21,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Implement borrower confirmation flow",
      "description": "As a borrower in a Mutual debt, I want to review and confirm or reject a debt request so only agreed debts become active.",
      "acceptanceCriteria": [
        "Add member routes on debts: post :confirm, post :reject",
        "DebtsController#confirm: only the non-creator party can confirm. Sets debt status to 'active', calls InstallmentScheduleGenerator, creates notification for creator. Redirects to debt show page",
        "DebtsController#reject: only the non-creator party can reject. Sets debt status to 'rejected', creates notification for creator. Redirects to debt show page",
        "Prevent double-confirm (only pending debts can be confirmed/rejected)",
        "Update pages/debts/show.tsx: when debt is pending and current user is the confirming party, show a prominent confirmation banner with full debt details and Confirm/Reject buttons",
        "Creator sees 'Awaiting confirmation from [name]' status message instead",
        "All text translated (en/ar)",
        "Controller test: non-creator confirms pending debt — becomes active with installments",
        "Controller test: non-creator rejects pending debt — becomes rejected",
        "Controller test: creator cannot confirm own debt",
        "Controller test: already active debt cannot be confirmed again",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 22,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Implement payment submission",
      "description": "As a borrower, I want to submit a payment entry so the lender can review and approve it.",
      "acceptanceCriteria": [
        "Add nested routes: resources :debts do resources :payments, only: [:create] end",
        "Create app/controllers/payments_controller.rb with create action",
        "Mutual mode: creates payment with status 'pending', sets submitted_by to current_user, sets submitted_at to now. Creates notification for lender",
        "Personal mode: creates payment with status 'approved' immediately (auto-approved, self-reported). No separate balance column needed — remaining balance is always calculated as: debt.amount minus debt.payments.where(status: 'approved').sum(:amount)",
        "Validation: amount > 0, amount <= remaining balance (total debt amount minus total approved payments), debt must be active",
        "If debt has installments, accept optional installment_id to link payment to a specific installment",
        "Update pages/debts/show.tsx: add 'Submit Payment' button (visible to borrower on active debts only). Button opens a dialog/form with: amount (numeric), date (date picker, defaults to today), description (optional textarea), installment link (optional select dropdown)",
        "Payment appears in payment history immediately after submission",
        "All text translated (en/ar)",
        "Controller test: borrower submits valid payment — status pending, lender notified",
        "Controller test: personal mode payment auto-approved",
        "Controller test: payment exceeding remaining balance rejected",
        "Controller test: payment on settled debt rejected",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 23,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Implement payment approval and auto-settlement",
      "description": "As a lender, I want to approve or reject submitted payments so both parties agree on every transaction.",
      "acceptanceCriteria": [
        "Add member routes on payments: post :approve, post :reject",
        "PaymentsController#approve: sets payment status to 'approved'. If payment linked to installment, mark installment as 'approved' if fully covered. Creates notification for borrower",
        "PaymentsController#reject: sets payment status to 'rejected' with optional rejection_reason param. Creates notification for borrower",
        "Auto-settlement: after approving a payment, check if total approved payments >= debt amount. If so, set debt status to 'settled' and create settlement notifications for both parties",
        "Only the lender can approve/reject. Only pending payments can be approved/rejected",
        "Update pages/debts/show.tsx: pending payments show 'Approve' (green) and 'Reject' (red) buttons visible only to the lender. Approved payments show green badge. Rejected payments show red badge with rejection reason",
        "All text translated (en/ar)",
        "Controller test: lender approves payment — status approved, borrower notified",
        "Controller test: lender rejects payment with reason — status rejected, borrower notified",
        "Controller test: approval triggers auto-settlement when fully paid",
        "Controller test: borrower cannot approve payments",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 24,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Implement witness assignment",
      "description": "As a debt creator, I want to invite witnesses to a debt so it follows Quranic guidelines.",
      "acceptanceCriteria": [
        "Add nested routes: resources :debts do resources :witnesses, only: [:create] do member do post :confirm; post :decline end end end",
        "Create app/controllers/witnesses_controller.rb with create, confirm, and decline actions",
        "Create: accepts Personal ID, looks up user, creates witness with status 'invited', sends notification. Max 2 witnesses per debt. Prevent duplicate invitations (same user for same debt)",
        "Confirm: invited witness sets status to 'confirmed' and confirmed_at. Only the invited witness can confirm",
        "Decline: invited witness sets status to 'declined'. Only the invited witness can decline",
        "Confirmed witnesses gain read-only access to the debt detail page (update authorization in DebtsController#show)",
        "Update pages/debts/show.tsx: add 'Add Witnesses' section with Personal ID input (visible to debt creator on non-settled debts). Show witness list with status badges. Invited witnesses see Accept/Decline buttons",
        "Update Quranic compliance reminder on debt detail page: personal mode + no confirmed witnesses = strong reminder, mutual mode + no confirmed witnesses = standard reminder, any confirmed witnesses = no reminder",
        "All text translated (en/ar)",
        "Controller test: invite witness successfully",
        "Controller test: max 2 witnesses enforced",
        "Controller test: duplicate invitation prevented",
        "Controller test: witness confirms",
        "Controller test: witness declines",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 25,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Build debt dashboard with per-currency summaries",
      "description": "As a user, I want a dashboard showing my financial overview per currency so I can see all debts at a glance.",
      "acceptanceCriteria": [
        "Create app/controllers/dashboard_controller.rb with index action, inheriting from InertiaController",
        "Query logic: for each currency the user has active debts in, calculate — total amount as lender (lent), total amount as borrower (borrowed), total approved payments received/made, remaining balance, next upcoming installment (earliest due_date where status is 'upcoming'), count of active debts, count of settled debts. Include both Mutual and Personal debts",
        "GET /dashboard renders pages/dashboard/index.tsx",
        "Update authenticated root route to point to dashboard#index",
        "Dashboard shows a summary Card per currency with: currency code, total lent/borrowed, total paid, remaining, next installment date and amount, active/settled counts",
        "Below summary cards: list of 5 most recent debts with counterparty name, amount, status badge, linked to debt detail page",
        "'New Debt' prominent CTA button linking to /debts/new",
        "Empty state for users with no debts: Ayat al-Dayn welcome message with verse excerpt and 'Create Your First Debt' button",
        "All text translated (en/ar), RTL layout correct",
        "Controller test: empty state for new user",
        "Controller test: single currency summary",
        "Controller test: multiple currencies",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 26,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Build debts list page with filtering and sorting",
      "description": "As a user, I want to see all my debts in a filterable, sortable list so I can manage them.",
      "acceptanceCriteria": [
        "DebtsController#index queries all debts where current_user is lender, borrower, or creator (Personal mode)",
        "Support URL query params for filters: status (all/pending/active/settled/rejected), mode (all/mutual/personal), role (all/lender/borrower)",
        "Support URL query param for sort: created_at_desc (default), deadline_asc, amount_desc",
        "GET /debts renders pages/debts/index.tsx",
        "Each debt row shows: counterparty name, amount with currency, status badge, mode badge, deadline, progress bar (total approved payments / total amount as percentage)",
        "Filter dropdowns using shadcn Select components. Changing a filter updates URL params and re-fetches via Inertia",
        "Sort selector dropdown",
        "Clicking a debt row navigates to /debts/:id",
        "Empty state message when no debts match filters",
        "All text translated (en/ar)",
        "Controller test: index returns only user's debts",
        "Controller test: filter by status",
        "Controller test: filter by mode",
        "Controller test: sort by deadline",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 27,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Create NotificationService and notifications backend",
      "description": "As a developer, I need a centralized notification service so all debt events create consistent notifications.",
      "acceptanceCriteria": [
        "Create app/services/notification_service.rb with class methods for each notification type: debt_created(debt), debt_confirmed(debt), debt_rejected(debt), payment_submitted(payment), payment_approved(payment), payment_rejected(payment), witness_invited(witness), witness_confirmed(witness), debt_settled(debt)",
        "Each method creates a Notification record with appropriate user_id, notification_type, message (translatable key), and debt_id",
        "Create app/controllers/notifications_controller.rb with index and mark_read actions",
        "GET /notifications returns all notifications for current_user, ordered by created_at desc",
        "POST /notifications/:id/mark_read sets read: true",
        "POST /notifications/mark_all_read sets all unread notifications for current_user to read: true",
        "Share unread notification count via inertia_share in InertiaController (available to all pages for the header bell)",
        "Refactor all existing controller actions (debt creation, confirmation, payment, witness) to use NotificationService instead of inline notification creation",
        "Controller test: notifications index returns user's notifications",
        "Controller test: mark single notification as read",
        "Controller test: mark all as read",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 28,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "Build notifications page UI and header bell",
      "description": "As a user, I want to see my notifications in a list and have a bell icon showing unread count in the header.",
      "acceptanceCriteria": [
        "Create pages/notifications/index.tsx with a list of all notifications, newest first",
        "Each notification shows: icon by type (different lucide-react icons for debt/payment/witness events), message text, relative time (e.g., '2 hours ago'), read/unread visual indicator (bold for unread), link to related debt",
        "Clicking a notification marks it as read (POST /notifications/:id/mark_read) and navigates to the related debt page",
        "'Mark all as read' button at the top of the list",
        "Update app-layout.tsx header: add Bell icon with unread count badge (red circle with number). Badge hidden when count is 0. Clicking bell navigates to /notifications",
        "All notification messages and UI text translated (en/ar)",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 29,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "Create DebtMailer for email notifications",
      "description": "As a user, I want to receive email notifications for important debt events so I don't miss critical activity.",
      "acceptanceCriteria": [
        "Create app/mailers/debt_mailer.rb with methods: debt_created(debt, recipient), debt_confirmed(debt, recipient), payment_submitted(payment, recipient), payment_approved(payment, recipient), payment_rejected(payment, recipient), witness_invitation(witness), debt_settled(debt, recipient)",
        "Each email includes: greeting with recipient's full_name, event description, debt summary (amount, currency, counterparty), link to debt detail page",
        "Emails rendered in the recipient's preferred locale (user.locale)",
        "Create email view templates in app/views/debt_mailer/ (ERB, not Inertia)",
        "Integrate with NotificationService: each notification method also enqueues the corresponding mailer via deliver_later",
        "Mailer test: each email type renders correct content",
        "Mailer test: email sent to correct recipient",
        "Mailer test: email uses recipient's locale",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 30,
      "passes": true,
      "notes": "Emails use standard Rails ERB templates, not Inertia. Use Active Job (deliver_later) for async delivery."
    },
    {
      "id": "US-031",
      "title": "Replace Solid Queue with GoodJob and create scheduled jobs",
      "description": "As a developer, I need GoodJob for background jobs and scheduled reminders so installment reminders and overdue detection work automatically.",
      "acceptanceCriteria": [
        "Remove solid_queue gem from Gemfile. Add good_job gem",
        "Run rails generate good_job:install to create migration. Run rails db:migrate",
        "Configure GoodJob as Active Job backend in config/application.rb: config.active_job.queue_adapter = :good_job",
        "Mount GoodJob dashboard in config/routes.rb at /good_job. In production, protect behind authentication (e.g., authenticate :user, ->(u) { u.admin? } or basic HTTP auth)",
        "Remove Solid Queue configuration files (config/queue.yml, db/queue_schema.rb, db/queue_migrate/)",
        "Update Puma config to remove solid_queue plugin reference if present",
        "Create app/jobs/installment_reminder_job.rb: finds installments with due_date 3 days from now, 1 day from now, or today with status 'upcoming'. Creates in-app notification and sends email to both lender and borrower for each",
        "Create app/jobs/overdue_detection_job.rb: finds installments with due_date < today and status 'upcoming'. Updates status to 'overdue'. Creates notification and sends email to both parties",
        "Configure GoodJob cron schedule in config/initializers/good_job.rb: run OverdueDetectionJob daily at midnight UTC, run InstallmentReminderJob daily at 8:00 AM UTC",
        "Job test: InstallmentReminderJob sends reminders for due-soon installments",
        "Job test: OverdueDetectionJob marks overdue installments and notifies",
        "Job test: already overdue installments are not re-processed",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 31,
      "passes": true,
      "notes": "GoodJob uses PostgreSQL for job storage — no Redis dependency needed."
    },
    {
      "id": "US-032",
      "title": "Implement Personal-to-Mutual debt upgrade",
      "description": "As a debt creator, I want to link a Personal debt to a registered user so it becomes a Mutual debt with full two-sided workflow.",
      "acceptanceCriteria": [
        "Add member routes on debts: post :upgrade, post :accept_upgrade, post :decline_upgrade",
        "Add a migration: add upgrade_recipient_id (bigint FK to users, nullable) column to debts table. This tracks who was invited to upgrade (null means no upgrade pending)",
        "DebtsController#upgrade: only creator of a Personal active debt can initiate. Accepts Personal ID of the other party. Looks up user. Sets debt.upgrade_recipient_id to the looked-up user. Creates a notification with full debt details and payment history for the other party",
        "DebtsController#accept_upgrade: only the user matching debt.upgrade_recipient_id can accept. Debt mode changes to 'mutual', borrower_id or lender_id set to upgrade_recipient_id based on creator_role, upgrade_recipient_id set to null. All future payments require submit/approve workflow. Historical payments (already status 'approved') remain unchanged. Notify creator",
        "DebtsController#decline_upgrade: only the user matching debt.upgrade_recipient_id can decline. Sets upgrade_recipient_id to null. Debt remains Personal. Notify creator",
        "Cannot upgrade a settled or rejected debt",
        "Update pages/debts/show.tsx: show 'Link to registered user' button on Personal active debts (creator view only). Button opens dialog with Personal ID input and user name confirmation. Other party sees upgrade request with Accept/Decline buttons",
        "Self-reported payments in history show a 'Self-reported' badge for transparency",
        "All text translated (en/ar)",
        "Controller test: upgrade request sent successfully",
        "Controller test: accept upgrade changes mode to mutual",
        "Controller test: decline upgrade keeps personal mode",
        "Controller test: cannot upgrade settled debt",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 32,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-033",
      "title": "Implement debt auto-settlement and archive",
      "description": "As a user, I want settled debts archived with full history preserved and read-only access enforced.",
      "acceptanceCriteria": [
        "Verify auto-settlement logic works end-to-end: when PaymentsController#approve causes total approved payments >= debt amount, debt status transitions to 'settled'. Both parties receive settlement notification with congratulatory message referencing Ayat al-Dayn",
        "Update debts list page: add 'Archive' tab/filter that shows only settled debts. Settled debts have a distinct visual style (muted colors or archive icon)",
        "Update debt detail page for settled debts: all action buttons hidden (no submit payment, no approve, no add witnesses). Page is fully read-only. Show complete history: all installments with final statuses, all payments with approval statuses, all witnesses with statuses, timestamps for everything",
        "Witnesses can still view archived/settled debts",
        "All text translated (en/ar)",
        "Controller test: settled debt show page is read-only (no payment/witness actions available)",
        "Controller test: cannot submit payment on settled debt (returns error)",
        "Controller test: cannot add witness to settled debt (returns error)",
        "Typecheck passes",
        "Tests pass",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 33,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-034",
      "title": "Integrate Ayat al-Dayn verse throughout UI",
      "description": "As a user, I want to see relevant portions of Ayat al-Dayn woven throughout the app as a spiritual anchor.",
      "acceptanceCriteria": [
        "Create app/frontend/components/ayat-al-dayn.tsx reusable component that displays verse excerpt in Arabic script with translation in the user's language. Component accepts a 'context' prop to show different excerpts (welcome, creation, detail, witness, settlement)",
        "Welcome/onboarding: after registration, show verse excerpt with translation on the redirect page or dashboard empty state",
        "Debt creation flow (pages/debts/new.tsx): contextual snippet displayed in a subtle card alongside the form",
        "Debt detail page (pages/debts/show.tsx): verse banner/card on the page",
        "Witness assignment section: when inviting witnesses, show the verse's guidance on witnesses (واستشهدوا شهيدين من رجالكم)",
        "Settlement: when debt is settled, show congratulatory message tied to the verse",
        "Empty dashboard: welcome message with verse excerpt and app purpose",
        "Verse always displayed in Arabic script (Uthmani) regardless of UI language",
        "Translation shown in the user's selected language via i18n",
        "All verse text stored in translation files (en.json/ar.json), not hardcoded in components",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 34,
      "passes": false,
      "notes": "Use different portions of Surah Al-Baqarah 2:282 for each context. Keep the display subtle and non-intrusive."
    }
  ]
}
